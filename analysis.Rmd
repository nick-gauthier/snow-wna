---
title: "Snowpack variability in western North America over the common era"
subtitle: "Models and Observations"
author: "Nick Gauthier"
date: "Last knit on: `r Sys.Date()`"
output:
  tufte::tufte_html: default
  tufte::tufte_handout:
    citation_package: natbib
    latex_engine: xelatex
  tufte::tufte_book:
    citation_package: natbib
    latex_engine: xelatex
bibliography: skeleton.bib
link-citations: yes
---

Analysis of snowpack dynamics in western North America over the Common Era.

## Setup

Import the packages required for this analysis.

```{r}
library(raster) # processing raster data
library(tidyverse) # data manipulation and visualization
library(mgcv) # flexible nonlinear regression models
library(furrr) # parallel processing
library(gganimate) # animated gifs
library(ggridges)
```

Define a study area to constrain all computaitons.
```{r}
bbox <- extent(c(-125, -104, 33, 50))
```

Import the snow observation data from https://nsidc.org/data/nsidc-0719.^[What's up with this warning message? long_name=CRS definition
spatial_ref=GEOGCS["NAD83",DATUM["North_American_Datum_1983",SPHEROID["GRS 1980",6378137,298.257222101,AUTHORITY["EPSG","7019"]],AUTHORITY["EPSG","6269"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.01745329251994328,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4269"]]
GeoTransform=-125.0208 0.04166662697178698 0 49.9375 0 -0.04166662697178698]

```{r, message=FALSE,warning=FALSE}
plan(multisession) # setup parallel processing

preprocess <- function(x, var) {
  brick(x, varname = var) %>%
    crop(bbox) %>%
    sum() %>%
    aggregate(fact = 2, na.rm = TRUE)
}

swe_obs <- list.files('data/', pattern = 'SWE_Depth', full.names = TRUE) %>%
  future_map(preprocess, var = 'SWE') %>%
  brick() %>%
  setNames(1982:2017)

depth_obs <- list.files(pattern = 'SWE_Depth', full.names = TRUE) %>%
  future_map(preprocess, var = 'DEPTH') %>%
  brick() %>%
  setNames(1982:2017)
```

Import elevation and resample.
```{r}
elev <- raster('~/gdrive/Data/SRTM_1km.tif') %>%
  crop(bbox) %>%
  resample(depth_obs)
```

Turn the rasters into data frames and join.

```{r}
swe_dat <- swe_obs %>%
  as.data.frame(xy = TRUE, na.rm = TRUE, long = TRUE) %>%
  rename(water_year = layer, SWE = value)

depth_dat <- depth_obs %>%
  as.data.frame(xy = TRUE, na.rm = TRUE, long = TRUE) %>%
  rename(water_year = layer, DEPTH = value)

elev_dat <- elev %>%
  as.data.frame(xy = TRUE, na.rm = TRUE) %>%
  rename(elev = SRTM_1km)

snow_dat <- swe_dat %>%
  left_join(depth_dat, by = c('x', 'y', 'water_year')) %>%
  left_join(elev_dat, by = c('x', 'y')) %>%
  mutate(water_year = parse_number(water_year))
```



```{r}
snow_dat %>%
  arrange(y) %>%
ggplot(aes(water_year, SWE, group = interaction(x, y))) +
  geom_line(aes(color = y), alpha = 0.1) +
  theme_classic()
```

```{r}
m1 <- bam(SWE ~ s(elev, bs = 'cr') + te(x,y, by = as.factor(water_year)), data = snow_dat, discrete = TRUE)
plot(m1)
summary(m1)
```


```{r}
ggplot(swe_dat, aes(x = log(SWE + 1), y = as.factor(water_year), fill = ..x..)) +
  geom_density_ridges_gradient()
```

Filter out the 0s
```{r}
swe_dat %>%
  filter(SWE > 0) %>%
ggplot(aes(x = SWE, y = as.factor(water_year), fill = ..x..)) +
  geom_density_ridges_gradient() +
  scale_x_log10() +
  scale_fill_viridis_c() +
  theme_minimal()
```

Animate

```{r}
swe_dat %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = SWE)) +
  scale_fill_viridis_c() +
  coord_quickmap()+
  theme_void() +
  ggtitle("Year: {closest_state}") +
  transition_states(water_year)
```
First let's model the relationship between snow depth and snow water equivalent (i.e. snow density) in the observations.

```{r}
snow_dat %>%
  filter(DEPTH < 1e+6) %>%
  ggplot(aes(DEPTH, SWE)) +
  geom_point()


m1 <- bam(SWE ~ DEPTH, data = snow_dat)
m2 <- bam(SWE ~ s(DEPTH), data = snow_dat, discrete = TRUE)
m3 <- bam(SWE ~ s(DEPTH), data = snow_dat, discrete = TRUE, select = TRUE)

plot(m2)
plot(m3)

test <- snow_dat %>%
  mutate(m1 = SWE - predict(m1, .),
         m2 = SWE - predict(m2, .),
         m3 = SWE - predict(m3, .))

test %>%
  select(m1:m3) %>%
  gather(model, error) %>%
  group_by(model) %>%
  summarise(rmse = sqrt(mean(error ^2)))

test %>%
  filter(water_year %in% 1995:1997) %>%
    gather(model, error, m1:m3) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = error)) +
  scale_fill_viridis_c() +
  facet_grid(model~water_year) +
  coord_quickmap()+
  theme_void()
```
Compare to climatological data for annual temperature range.

```{r}
temp_range <- brick('CHELSA_bio10_07.tif') %>%
  crop(bbox)

prec_djf <- (raster('CHELSA_prec_01_V1.2_land.tif') + 
  raster('CHELSA_prec_02_V1.2_land.tif') + 
  raster('CHELSA_prec_12_V1.2_land.tif')) %>%
  crop(bbox) %>%
  `/`(3)

plot(prec_djf)
```


```{r}
plot(temp_range)
```


```{r}
swe_dat %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = log(SWE + 1))) +
  scale_fill_viridis_c() +
  coord_quickmap()+
  theme_void() +
  ggtitle("Water Year: {closest_state}") +
  transition_states(water_year)
```

```{r}
swe_dat %>%
  group_by(x, y) %>%
  mutate(rho = cor(SWE, lag(SWE), use = 'complete.obs'))
```

```{r, warning = FALSE}
swe_dat %>%
  group_by(x, y) %>%
  mutate(rho = cor(SWE, lag(SWE), use = 'complete.obs')) %>%
   ggplot(aes(x, y)) +
  geom_raster(aes(fill = rho)) +
  scale_fill_viridis_c() +
  coord_quickmap()+
  theme_void() 
```


```{r}
swe_dat %>%
  group_by(water_year) %>%
  summarise(SWE = sum(SWE, na.rm = TRUE)) %>%
  ggplot(aes(water_year, SWE)) +
  geom_col(aes(fill = SWE)) +
  scale_fill_viridis_c()
```

```{r}
swe_dat %>%
  arrange(-SWE) 

swe_dat %>%
  pull(SWE) %>%
  hist
```




## Paleo
```{r}
brick('data/trace.01-36.22000BP.cam2.SNOWHLND.22000BP_decavg_400BCE.nc') %>%
  rotate() %>%
  crop(bbox, snap = 'out') %>% plot 

brick('data/trace.01-36.22000BP.clm2.SNOWDP.22000BP_decavg_400BCE.nc', varname = 'SNOWDP') %>%
  rotate() %>%
  crop(bbox, snap = 'out') %>% plot 
```


## Reanalysis
```{r}
ncdf_file <- 'adaptor.mars.internal-1566933160.7965047-18657-23-b3ae7b43-15db-4890-bc5b-4d3413fe4ddd.nc'
ref <- brick(ncdf_file, var = 'sd') %>% 
  .[[1]]%>%
  rotate %>%
  crop(bbox)

snowfall <- brick(ncdf_file, var = 'sf') %>% 
  rotate %>%
  crop(bbox) %>%
  mask(elev) %>%
  as.data.frame(xy = TRUE, long = TRUE) %>%
  rename(time = Z, sf = value)

snowdepth <- brick(ncdf_file, var = 'sd') %>% 
  rotate %>%
  crop(bbox) %>%
  mask(elev) %>%
  as.data.frame(xy = TRUE, long = TRUE) %>%
  rename(time = Z, sd = value)

temp <- brick(ncdf_file, var = 't2m') %>% 
  rotate %>%
  crop(bbox) %>%
  mask(elev) %>%
  as.data.frame(xy = TRUE, long = TRUE) %>%
  rename(time = Z, t2m = value)

precip <- brick(ncdf_file, var = 'tp') %>% 
  rotate %>%
  crop(bbox) %>%
  mask(elev) %>%
  as.data.frame(xy = TRUE, long = TRUE) %>%
  rename(time = Z, tp = value)
```

```{r}
test <- swe_obs %>%
  resample(ref, fun = sum)

plot(test[[1]])
```


```{r}
dat <- snowfall %>%
  left_join(snowdepth, by = c('x', 'y', 'time')) %>%
  left_join(temp, by = c('x', 'y', 'time')) %>%
  left_join(precip, by = c('x', 'y', 'time')) %>%
  as_tibble %>%
  separate(time, into = c('year', 'month', 'day'), convert = TRUE) %>%
  select(-day) %>%
  mutate(t2m = t2m - 273.15,
         season = case_when(month %in% c(12, 1, 2) ~ 'DJF',
                            month %in% c(3, 4, 5) ~ 'MAM',
                            month %in% c(6, 7, 8) ~ 'JJA',
                            month %in% c(9, 10, 11) ~ 'SON'))
```

```{r}
ggplot(dat, aes(t2m, sd)) +
  geom_point(alpha = .5) +
  facet_wrap(~season) +
  theme_bw()

ggplot(dat, aes(tp, sf)) +
  geom_point(alpha = .5) +
  facet_wrap(~season) +
  theme_bw()
```

```{r}
dat2 <- dat %>%
  mutate(water_year = if_else(month < 10, year, year + 1L)) %>%
  filter(between(water_year, 1980, 2018)) %>%
  group_by(x, y, water_year) %>%
  summarise(sd = sum(sd), t2m = mean(t2m), tp = sum(tp))
```


```{r}
dat2 %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = sd)) +
  scale_fill_viridis_c() +
  coord_quickmap()+
  theme_void() +
  ggtitle("Year: {closest_state}") +
  transition_states(water_year)
```

```{r}
dat2 %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = sd)) +
  scale_fill_viridis_c() +
  facet_wrap(~water_year) +
  coord_quickmap()+
  theme_void()
```

```{r}
dat2 %>%
  group_by(water_year) %>%
  summarise(sd = sum(sd, na.rm = TRUE)) %>%
  ggplot(aes(water_year, sd)) +
  geom_col(aes(fill = sd)) +
  scale_fill_viridis_c()
```

```{r}
dat2 %>%
  group_by(x, y) %>%
  summarise(rho = cor(sd, lag(sd), use = 'complete.obs')) %>%
  qplot(rho, geom = "histogram", data = .)

mod <- dat2 %>%
  mutate(start = if_else(water_year == min(water_year), TRUE, FALSE)) %>%
  filter(sd > 0) %>%
  bam(sd ~ te(t2m, tp) + te(x,y), data = ., AR.start = start)

summary(mod)
plot(mod, scheme = 1)
```
