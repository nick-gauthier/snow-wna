---
title: "Downscaling snowpack variability in western North America"
subtitle: "Models and Observations"
author: "Nick Gauthier"
date: "Last knit on: `r Sys.Date()`"
output:
  tufte::tufte_html: default
  tufte::tufte_handout:
    citation_package: natbib
    latex_engine: xelatex
  tufte::tufte_book:
    citation_package: natbib
    latex_engine: xelatex
link-citations: yes
---

Downscaling snow water equivalent 

# Introduction

## Preliminaries

Import the packages required for this analysis.

```{r setup}
knitr::opts_chunk$set(fig.width = 6, fig.asp = 0.618)

# analysis
library(raster) # processing raster data
library(tidyverse) # data manipulation and visualization
library(mgcv) # flexible nonlinear regression models
library(remote) # empirical orthogonal teleconnections

# plotting
library(sf) # shapefiles and plotting
library(gganimate) # animated gifs
library(scico) # color palettes

# this package
devtools::load_all()
```

```{r}
load('../data.Rdata')
```

```{r, echo = FALSE}
# download state boundary files for cropping and plotting
state_names <- c('arizona', 'new mexico', 'colorado', 
                 'california', 'utah', 'nevada', 
                 'oregon', 'washington', 'idaho',
                 'wyoming', 'montana')

states_wus <- maps::map('state', regions = state_names, 
                    fill = TRUE, plot = FALSE) %>% st_as_sf

states_mask <- prism[[1]] %>% mask(states_wus) %>% as.data.frame(na.rm = TRUE, xy = TRUE) %>% dplyr::select(-X1982)
```

# Modes of Snowpack Variability

## Observed Modes

```{r}
prism_climatology <- prism_dat %>%
  semi_join(states_mask) %>%
  group_by(x, y) %>%
  summarise(swe_mean = mean(SWE),
            swe_sd = sd(SWE))
```


```{r, echo = FALSE, fig.asp = .8}
ggplot(prism_climatology) +
  geom_raster(aes(x, y, fill = swe_mean)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  scale_fill_scico(palette = 'davos', direction = -1) +
  ggtitle('Mean March SWE, 1982-2017', 'PRISM/SNOTEL Observations')

ggplot(prism_climatology) +
  geom_raster(aes(x, y, fill = swe_sd)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  scale_fill_scico(palette = 'davos', direction = -1)+
  ggtitle('Standard Deviation of March SWE, 1982-2017', 'PRISM/SNOTEL Observations')
```


```{r prism_animation, fig.asp = 8, echo = FALSE, warning=FALSE, cache = TRUE}
prism_dat %>%
  filter(between(year, 2000, 2017)) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = SWE)) +
  scale_fill_scico(palette = 'davos', direction = -1) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  ggtitle("Snow Water Equivalent", "March, {closest_state}") +
  transition_states(year)
```

### PCA

Run a principal components analysis.
```{r}
prism_pcs <- calc_pcs(prism_dat, scale = TRUE)
```

Get the eigenvalues, and run some truncation tests.
```{r}
prism_eigs <- get_eigs(prism_pcs)
nFactors::nScree(prism_eigs$eigenvalues)
```

```{r, echo = FALSE}
plot_scree(prism_eigs, c(6, 14))
```
Lets start by truncating at 6. Extract the pc amplitude time series and EOF spatial patterns for the leading 6 modes.
```{r}
prism_patterns <- get_patterns(prism_pcs, prism_dat, prism_eigs, k = 9)
```

```{r, echo = FALSE}
plot_amps(prism_patterns)
```

```{r echo = FALSE, fig.width = 10, fig.height = 11}
plot_eof(prism_patterns, 'vik')
```
### Spatial information loss
```{r, fig.asp = .9}
swe_recon <- prism_patterns %>%
  unnest(amplitudes) %>%
  unnest(patterns) %>%
  mutate(anomaly = value * amplitude) %>%
  dplyr::select(-c(amplitude, value, weight)) %>%
  group_by(x, y, year) %>%
  summarize(anomaly = sum(anomaly)) %>%
    left_join(prism_climatology) %>%
  mutate(SWE = anomaly * swe_sd + swe_mean) 

swe_recon %>%
  left_join(prism_dat, by = c('x', 'y', 'year')) %>%
  mutate(error = (SWE.x - SWE.y) / swe_sd) %>%
filter(year <= 1985) %>% 
ggplot() +
  geom_raster(aes(x, y, fill = error)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  facet_wrap(~year) +
  scale_fill_scico(palette = 'vik', direction = -1, limits = c(-5, 5)) +
  ggtitle('Error from dimensionality reduction', 'PRISM')
```

## Teleconnections

To cite use of dataset: Boyin Huang, Peter W. Thorne, Viva F. Banzon, Tim Boyer, Gennady Chepurin, Jay H. Lawrimore, Matthew J. Menne, Thomas M. Smith, Russell S. Vose, and Huai-Min Zhang (2017): NOAA Extended Reconstructed Sea Surface Temperature (ERSST), Version 5. [indicate subset used]. NOAA National Centers for Environmental Information. doi:10.7289/V5T72FNM [access date].
Please note: If you acquire NOAA_ERSST_V5 data products from PSD, we ask that you acknowledge us in your use of the data. This may be done by including text such as NOAA_ERSST_V5 data provided by the NOAA/OAR/ESRL PSD, Boulder, Colorado, USA, from their Web site at https://www.esrl.noaa.gov/psd/ in any documents or publications using these data. We would also appreciate receiving a copy of the relevant publications. This will help PSD to justify keeping the NOAA_ERSST_V5 data set freely available online in the future. Thank you!

```{r, warning = FALSE}
sst_mean <- brick('data/sst.mon.ltm.1981-2010.nc')

sst_jan <- brick('data/sst.mnmean.nc') %>% 
  .[[505:1966]] %>%
  .[[seq(1, 1462, 12)]] %>% 
  `-`(sst_mean[[1]]) %>% crop(extent(c(-1, 359, -75, 75))) %>%
  disaggregate(fact = 2, method = 'bilinear')

reof_cor <- brick(
  calc(sst_jan, fun=function(x) cor(c(x),c(obs_reof$amplitude[,1]))),
  calc(sst_jan, fun=function(x) cor(c(x),c(obs_reof$amplitude[,2]) * -1)),
  calc(sst_jan, fun=function(x) cor(c(x),c(obs_reof$amplitude[,3]) * -1)),
  calc(sst_jan, fun=function(x) cor(c(x),c(obs_reof$amplitude[,4]) * -1)),
  calc(sst_jan, fun=function(x) cor(c(x),c(obs_reof$amplitude[,5]) * -1)),
  calc(sst_jan, fun=function(x) cor(c(x),c(obs_reof$amplitude[,6]) * -1))) %>%
  `names<-`(paste0('PC', 1:n_modes))
```


```{r, fig.width = 6, fig.height = 5.5}
world <- maps::map('world',wrap=c(0,360),fill = TRUE, plot = FALSE)
reof_cor %>% 
  as.data.frame(xy = T, na.rm = T) %>%
  gather(eof, value, PC1:PC6) %>%
    filter(value > .1 | value < -.1) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = value)) +
  facet_wrap(~eof, nrow = 3) +
  scale_fill_distiller(name = 'Correlation', palette = 'RdBu', direction = -1, limits = c(-.7,.7)) +
  coord_quickmap(ylim = c(-75,75), expand = FALSE) +
  geom_polygon(data = world, aes(x = long, y = lat, group = group)) +
  labs(#title = 'Drought teleconnections', 
       #subtitle = 'PC correlation to winter sea surface temperatures',
       x = 'Longitude', y = 'Latitude') +
  theme_bw() +
  theme(legend.position = "bottom")
```

```{r eval = FALSE, include = FALSE}
eof_cor <- brick(calc(sst_jan, fun=function(x) cor(c(x),obs_eof_amp %>% filter(PC == 1) %>% pull(amplitude))),
calc(sst_jan, fun=function(x) cor(c(x),obs_eof_amp %>% filter(PC == 2) %>% pull(amplitude))),
calc(sst_jan, fun=function(x) cor(c(x),obs_eof_amp %>% filter(PC == 3) %>% pull(amplitude))),
calc(sst_jan, fun=function(x) cor(c(x),obs_eof_amp %>% filter(PC == 4) %>% pull(amplitude))),
calc(sst_jan, fun=function(x) cor(c(x),obs_eof_amp %>% filter(PC == 5) %>% pull(amplitude))),
calc(sst_jan, fun=function(x) cor(c(x),obs_eof_amp %>% filter(PC == 6) %>% pull(amplitude))))

eof_cor %>% 
  as.data.frame(xy = T, na.rm = T) %>%
  gather(eof, value, layer.1:layer.6) %>%
  filter(value > .1 | value < -.1) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = value)) +
  facet_wrap(~eof, nrow = 3) +
  scale_fill_distiller(palette = 'RdBu', direction = -1, limits = c(-.7,.7)) +
  coord_quickmap(ylim = c(-75,75), expand = FALSE) +
  geom_polygon(data = world, aes(x = long, y = lat, group = group)) +
  ggtitle('EOFs') +
  theme_bw()
```


## Simulated Modes

```{r}
cera_climatology <- cera_dat %>% 
  group_by(x, y) %>%
  summarise(swe_mean = mean(SWE),
            swe_sd = sd(SWE))
```


```{r, echo = FALSE, fig.asp = .8}
ggplot(cera_climatology) +
  geom_raster(aes(x, y, fill = swe_mean)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  scale_fill_scico(palette = 'davos', direction = -1) +
  ggtitle('Mean March SWE, 1901-2010', 'CERA-20C Reanalysis')

ggplot(cera_climatology) +
  geom_raster(aes(x, y, fill = swe_sd)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  scale_fill_scico(palette = 'davos', direction = -1)+
  ggtitle('Standard Deviation of March SWE, 1901-2010', 'CERA-20C Reanalysis')
```

Run the principal components analysis.
```{r}
cera_pcs <- calc_pcs(cera_dat, scale = TRUE)
```

Get the eigenvalues, and run some truncation tests.
```{r}
cera_eigs <- get_eigs(cera_pcs)
nFactors::nScree(cera_eigs$eigenvalues)
```

```{r, echo = FALSE}
plot_scree(prism_eigs, 7)
```
```{r}
cera_patterns <- get_patterns(cera_pcs, cera_dat, cera_eigs, k = 9, mask = FALSE)
```

```{r, echo = FALSE}
plot_amps(cera_patterns)
```

```{r echo = FALSE}
plot_eof(cera_patterns, 'vik')
```

# Coupled Pattern Analysis

First look at just the error from the dimensionality reduction  with the PCs. This is basically the error in the pc targets, so is the minimum error we'd get even from the best downscaling

## GAM
```{r}
library(modelr)
```


```{r}
predictors <- cera_patterns %>%
  dplyr::select(-patterns) %>%
  unnest(amplitudes) %>%
  filter(year >= 1982) %>% 
    mutate(PC = paste0('PC', PC)) %>% 
  spread(PC, amplitude)

gam_mod <- prism_patterns %>%
    dplyr::select(-patterns) %>%
  unnest(amplitudes) %>%
  filter(year <= 2010) %>%
    mutate(PC = paste0('PC', PC)) %>% 
  left_join(predictors, by = 'year') %>%
  group_by(PC) %>%
  nest() %>%
  mutate(mod = map(data, ~gam(amplitude ~ 
                                s(PC1, k = 4) + 
                                s(PC2, k =5) + 
                                s(PC3, k = 4) + 
                                s(PC4, k = 4) + 
                                s(PC5, k = 4) + 
                                s(PC6, k = 4) + 
                                s(PC7, k = 4) +
                                s(PC8, k = 4) + 
                                s(PC9, k = 4), 
                              data = ., 
                              method = 'REML', 
                              select = TRUE))) %>%
  mutate(r2 = map_dbl(mod, ~summary(.)$r.sq)) %>%
  mutate(data = map2(data, mod, add_predictions),
         data = map2(data, mod, add_residuals)) 

gam_preds <- gam_mod %>%
  dplyr::select(PC, data) %>%
  unnest(cols = c(data)) %>%
  dplyr::select(PC, amplitude, year, pred, resid) %>%
  ungroup()
```

How do the models perform?
```{r}
gam_mod %>%
  dplyr::select(PC, r2) %>%
  arrange(-r2)
```


Are the residuals autocorrelated? Some are
```{r}
gam_preds %>%
  group_by(PC) %>%
  summarise(autocor = cor(resid, lag(resid), use = 'pairwise.complete.obs')) %>%
  arrange(-abs(autocor))
```

```{r}
ggplot(gam_preds, aes(year)) +
  geom_line(aes(y = amplitude)) +
  geom_line(aes(y = pred), color = 'red') +
  facet_wrap(~PC)
```

```{r}
ggplot(gam_preds, aes(resid)) +
  #geom_histogram() + 
  geom_density(fill = NA) +
  geom_vline(xintercept = 0, color = 'red', linetype = 2) +
  facet_wrap(~PC) +
  theme_bw()
```



```{r}
walk(gam_mod$mod, plot)
```


Looks like pc 6 in the prism data may represent a trend ... r2 of .36 without year term, .89 with it!
this seems likely, year is selected out of the model for most of the other pcs, but shows a strong negative correlation in pc 6



```{r}
gam_recon <- gam_mod %>%
  dplyr::select(-amplitude) %>%
  spread(year, pred) %>% 
  mutate(PC = as.character(parse_number(PC))) %>%
  left_join(prism_eofs, ., by = c('EOF' = 'PC')) %>%
  gather(year, amplitude, `1982`:`2010`) %>% ## change dates for cera
  mutate(SWE = value * amplitude,
         year = as.numeric(year)) %>%
  group_by(x, y, year) %>%
  summarise(anomaly = sum(SWE)) %>%
  left_join(prism_scaler) %>%
  mutate(SWE =  anomaly + avg)
```


```{r}
gam_recon %>%
filter(year <= 1987) %>% 
  mutate(SWE = if_else(SWE < 0, 0, SWE)) %>%
ggplot() +
  geom_raster(aes(x, y, fill = anomaly)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  facet_wrap(~year) +
  scale_fill_scico(palette = 'vik', direction = -1, limits = c(-1300, 1300)) +
  ggtitle('Observed mean April 1st SWE, 1982-2017', 'PRISM')

prism_dat %>%
    group_by(x, y) %>%
  mutate(SWE_mean = mean(SWE),
         anomaly = SWE - SWE_mean) %>% 
filter(year <= 1987) %>%
ggplot() +
  geom_raster(aes(x, y, fill = anomaly)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  facet_wrap(~year) +
  scale_fill_scico(palette = 'vik', direction = -1, limits = c(-1300, 1300)) +
  ggtitle('Observed mean April 1st SWE, 1982-2017', 'PRISM')
```


```{r}
gam_recon %>%
  left_join(prism_dat, by = c('x', 'y', 'year')) %>%
  mutate(error = SWE.x - SWE.y) %>%
filter(year <= 1987) %>%
ggplot() +
  geom_raster(aes(x, y, fill = error)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  facet_wrap(~year) +
  scale_fill_scico(palette = 'vik', direction = -1, limits = c(-450, 450)) +
  ggtitle('Observed mean April 1st SWE, 1982-2017', 'PRISM')
```


## CCA

```{r}
t1 <- pcs_prism %>%
  filter(year <= 2010) %>%
  spread(PC, amplitude) %>%
  dplyr::select(-year) %>%
  as.matrix() %>%
  scale()

t2 <- pcs_cera %>%
  filter(year >= 1982) %>% 
    spread(PC, amplitude) %>%
  dplyr::select(-year) %>%
  as.matrix() %>%
  scale()

can_cor<- cancor(t1, t2, xcenter = FALSE, ycenter = FALSE) # pcs already centered
```

```{r}
can_cor$cor
```

```{r}
cera_can <- cera_eofs %>%
  dplyr::select(-value) %>%  # use normlaized or unnormalized?
  spread(EOF, weight) %>%
  dplyr::select(-x, -y) %>%
  as.matrix() %>%
  `%*%`(can_cor$ycoef) %>%
    `colnames<-`(paste0('PC', 1:7)) %>%
  as_tibble()
  
prism_can <- prism_eofs %>%
  dplyr::select(-value) %>%
  spread(EOF, weight) %>%
  dplyr::select(-x, -y) %>%
  as.matrix() %>%
  `%*%`(can_cor$xcoef) %>%
  `colnames<-`(paste0('PC', 1:7)) %>%
  as_tibble()
```

```{r}
cera_dat %>%
  spread(year, SWE) %>%
  mutate(column = 1:n()) %>%
  dplyr::select(x, y, column) %>%
  bind_cols(cera_can) %>%
  gather(pattern, value, PC1:PC7) %>% 
  ggplot() +
  geom_raster(aes(x, y, fill = value)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  facet_wrap(~pattern) +
      scale_fill_scico(palette = 'broc', direction = -1, limits = c(-1, 1) * 8) +
  theme_void()+
  coord_sf() +
  ggtitle('Reanalysis CCA')

prism_dat %>%
  spread(year, SWE) %>%
  mutate(column = 1:n()) %>%
  dplyr::select(x, y, column) %>%
  bind_cols(prism_can) %>%
  gather(pattern, value, PC1:PC7) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = value)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  facet_wrap(~pattern) +
      scale_fill_scico(palette = 'broc', direction = -1, limits = c(-1, 1) * 80) +
  theme_void()+
  coord_sf() +
  ggtitle('Observed CCA')
```

```{r}
library(patchwork)
plot_cancor <- function(x1, x2, y1, y2){
  p1 <- x1 %>%
  spread(year, SWE) %>%
  mutate(column = 1:n()) %>%
  dplyr::select(x, y, column) %>%
  bind_cols(x2) %>%
  gather(pattern, value, PC1:PC7) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = value)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  facet_wrap(~pattern) +
  scale_fill_distiller(palette = 'RdBu') +
  theme_void()+
  #coord_quickmap() +
  ggtitle('Reanalysis CCA') +
    theme(legend.position = 'bottom')

p2 <- y1 %>%
  spread(year, SWE) %>%
  mutate(column = 1:n()) %>%
  dplyr::select(x, y, column) %>%
  bind_cols(y2) %>%
  gather(pattern, value, PC1:PC7) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = value)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  facet_wrap(~pattern) +
  scale_fill_distiller(palette = 'RdBu') +
  theme_void()+
  #coord_quickmap() +
  ggtitle('Observed CCA') +
  theme(legend.position = 'bottom')

p1 + p2
}

plot_cancor(cera_dat, cera_can, prism_dat, prism_can)
```


```{r}
library(telefit)

t1 <- prism_dat %>%
  filter(year <= 2010) %>%
  snow_only() %>%
  spread(year, SWE) %>%
  dplyr::select(-x, -y) %>%
  as.matrix()

t2 <- cera_dat %>%
  filter(year >= 1982) %>% 
  snow_only() %>%
  spread(year, SWE) %>%
  dplyr::select(-x, -y) %>%
  as.matrix()


t3 <- prism_dat %>%
  filter(year <= 2010) %>%
  snow_only() %>%
  spread(year, SWE) %>%
  dplyr::select(x, y)

tele.preds <- cca.predict(t2, t1, t2, k.x = 7, k.y = 4)
1 - var(as.numeric(tele.preds-t1)) / var(as.numeric(t1))
```

it looks like for some reason the cca.predict function isn't rescaling correctly? or its just meant to work with standardized anomalies?

```{r}
prism_scaler <- prism_dat %>%
  group_by(x,y) %>%
  summarise(avg = mean(SWE), sdev = sd(SWE, na.rm = TRUE))
```

```{r}
prism_dat %>%
  filter(year <= 2010) %>%
  snow_only() %>%
  spread(year, SWE) %>%
  dplyr::select(x, y) %>%
  cbind(tele.preds) %>%
  gather(year, SWE, `1982`:`2010`) %>%
  left_join(prism_scaler) %>%
  mutate(SWE = SWE * sdev + avg) %>%
  filter(year <=1984) %>%
  ggplot(aes(x,y)) +
  geom_raster(aes(fill = SWE)) +
  facet_wrap(~year) +
  coord_quickmap()
```


```{r}
cca.predict
```


## EOTs

```{r}
eot1 <- cera_dat %>%
  filter(year >= 1982) %>%
  spread(year, SWE) %>%
  rasterFromXYZ() %>%
  anomalize() %>%
  denoise(expl.var = .85, weighted = TRUE)

eot2 <- prism_dat %>%
  filter(year <= 2010) %>%
  spread(year, SWE) %>%
  rasterFromXYZ() %>%
  anomalize() %>% 
  denoise(expl.var = .85, weighted = TRUE)
```

```{r}
telecon <- eot(eot1, eot2, n = 6)
```


```{r}
walk(1:6, ~plot(telecon, y = ., show.bp = TRUE))
```

```{r}
predict(telecon, eot1) %>% .[[1]] %>% `+`(mean(prism)) %>% plot
```

# Validation


```{r}
anomaly_dat <- prism_dat %>%
  filter( year <= 2010) %>% # important to make sure everything's calculated on the same time scale, may be best to do this further up?
  group_by(x, y) %>%
  mutate(swe_mean = mean(SWE),
         swe_sd = sd(SWE, na.rm = TRUE),
         anomaly = SWE - swe_mean) %>%
  ungroup()

tele_dat <- tele.preds %>%
  as_tibble() %>%
  bind_cols(t3, .) %>%
  gather(year, tele_pred, `1982`:`2010`) %>%
  mutate(year = as.numeric(year)) %>%
  left_join(anomaly_dat)  %>%
  mutate(swe_pred = tele_pred * swe_sd + swe_mean,
         res = swe_pred - SWE) 
```

```{r, echo = FALSE}
tele_dat %>%
  filter(year < 1985) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = tele_pred)) +
  scale_fill_viridis_c() +
  facet_wrap(~year) +
  coord_quickmap()

tele_dat %>%
  filter(year < 1985) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = anomaly)) +
  scale_fill_distiller(palette = 'RdBu') +
  facet_wrap(~year) +
  coord_quickmap()
```

```{r, echo = FALSE}
tele_dat %>%
  filter(year == 1985) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = swe_mean)) +
  scale_fill_viridis_c() +
  facet_wrap(~year) +
  coord_quickmap()

tele_dat %>%
  filter(year == 1985) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = swe_sd)) +
  scale_fill_viridis_c() +
  facet_wrap(~year) +
  coord_quickmap()
```

```{r}
plot(mean(prism));plot(calc(prism, sd))
```

```{r}
tele_dat %>%
  mutate(test = tele_pred * swe_sd + swe_mean) %>%
    filter(year == 1985) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = test)) +
  scale_fill_viridis_c() +
  facet_wrap(~year) +
  coord_quickmap()

tele_dat %>%
  mutate(test = tele_pred * swe_sd + swe_mean) %>%
    filter(year == 1985) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = SWE)) +
  scale_fill_viridis_c() +
  facet_wrap(~year) +
  coord_quickmap()
```

```{r}
tele_dat %>%
  mutate(swe_pred = tele_pred * swe_sd + swe_mean,
         error = swe_pred - SWE) %>%
      filter(year < 1985) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = error)) +
  scale_fill_distiller(palette = 'RdBu') +
  facet_wrap(~year) +
  coord_quickmap()
```

```{r}
t7 <- prism_dat %>%
  filter(year <= 2010) %>%
  spread(year, SWE) %>%
  rasterFromXYZ()

eot_rmse <- (predict(telecon, eot1) + mean(t7) - t7)^2 %>%
  cellStats(stat = 'mean') %>%
  sqrt()

cca_rmse <- tele_dat %>%
  mutate(swe_pred = tele_pred * swe_sd + swe_mean,
         error = swe_pred - SWE) %>% 
  group_by(year) %>%
  summarise(rmse = sqrt(mean(error ^ 2))) 

gam_rmse <- gam_recon %>%
  left_join(prism_dat, by = c('x', 'y', 'year')) %>%
  mutate(error = SWE.x - SWE.y) %>%
  group_by(year) %>%
  summarise(rmse = sqrt(mean(error ^ 2))) 

left_join(gam_rmse, cca_rmse, by = 'year') %>%
  mutate(eot_rmse = eot_rmse) %>%
  gather(method, rmse, rmse.x:eot_rmse) %>%
  ggplot(aes(year, rmse)) +
  geom_line(aes(color = method))
```

So the gam is in part effective here because it resolves recent snow droughts ... I wonder if this is a global warming trend?
```{r}
tele_dat %>%
  filter(year == 2005 ) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = anomaly)) +
  scale_fill_distiller(palette = 'RdBu', limits = c(-1100, 1100)) +
  facet_wrap(~year) +
  coord_quickmap()
```


```{r}
test2 <- tele.preds %>%
as_tibble() %>%
  bind_cols(t3, .) %>%
  rasterFromXYZ() 

plot(((test2 * calc(prism, sd) + mean(prism)) - prism )[[24]])
```

```{r}
plot(mean(prism) - prism)
mean(prism) - prism

tele.preds %>%
  as.tibble() %>%
  bind_cols(t3, .)
```


```{r, echo = FALSE}
knitr::knint_exit()
```


Some aggregate statistics. Is this the right way to aggregate?

```{r}
obs_agg <- prism_dat %>%
  filter(SWE > 0) %>%
  group_by(year) %>%
  summarise(SWE = sum(SWE * area), # units in megaliters (?)
            area = sum(area))
```

How has total SWE varied over the observational period?
```{r, echo = FALSE, fig.fullwidth = TRUE}
ggplot(obs_agg, aes(year, SWE)) +
  #geom_vline(xintercept = 2015, color = 'red', linetype = 2) +
  geom_col(aes(fill = SWE)) +
  scale_fill_viridis_c(guide = FALSE) +
  theme_minimal() +
  ggtitle('Total SWE over western North America')
```

```{r, echo = FALSE, fig.fullwidth = TRUE}
ggplot(obs_agg, aes(year, SWE)) +
  #geom_vline(xintercept = 2015, color = 'red', linetype = 2) +
  geom_point(aes(color = SWE)) +
  scale_color_viridis_c(guide = FALSE) +
  geom_smooth(method = 'lm') +
  theme_minimal() +
  ggtitle('Total SWE over western North America')
```

What about total area covered?
```{r, echo = FALSE, fig.fullwidth = TRUE}
ggplot(obs_agg, aes(year, area)) +
  geom_col(aes(fill = area)) +
  scale_fill_viridis_c(guide = FALSE) +
  theme_minimal() +
  ggtitle('Total snow area over western North America')
```

```{r, echo = FALSE}
ggplot(obs_agg, aes(area, SWE)) +
  geom_point(aes(color = year), size = 2.5) +
  scale_color_viridis_c() +
  geom_smooth(method = 'lm') +
  theme_minimal() +
  labs(x = 'Area (km2)', title = 'Relationship between total SWE and snow extent')
```


# Visualization



```{r}
cera_dat %>%
  group_by(x, y) %>%
  summarise(SWE = mean(SWE))%>%
  ggplot() +
  geom_raster(aes(x, y, fill = SWE)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  scale_fill_scico(palette = 'davos', direction = -1) +
  ggtitle('Reanalysis mean March SWE, 1900-2010', 'PRISM')
```


To what extent is this mismatch due to bias or scale effects? Test by resampling the observations to the CERA grid.

```{r, echo = FALSE}
mean_swe_cera <- cera_dat %>%
  filter(year >= 1982) %>%
  group_by(x, y) %>%
  summarise(sim = mean(SWE))

prism_resamp <- prism %>%
  subset(1:29) %>%
  mean %>%
  resample(cera) %>%
  as.data.frame(xy = TRUE, na.rm = TRUE) %>%
  rename(obs = layer)

left_join(prism_resamp, mean_swe_cera, by = c('x', 'y')) %>%
  gather(type, SWE, 3:4) %>%
ggplot() +
  geom_raster(aes(x, y, fill = SWE)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  facet_wrap(~type) +
    scale_fill_scico(palette = 'davos', direction = -1) +
  ggtitle('Observed vs Simulated mean March SWE', '1982-2010')
```


Look at how SWE has varied over time and space.

```{r cera_animation, echo = FALSE, warning=FALSE,cache = TRUE}
cera_dat %>%
  ggplot() +
  geom_raster(aes(x, y, fill = SWE)) +
    scale_fill_scico(palette = 'davos', direction = -1) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  ggtitle("Snow Water Equivalent", "March, {closest_state}") +
  transition_states(year)
```

```{r, echo = FALSE}
prism_dat %>%
  group_by(x, y) %>%
  mutate(anomaly = SWE - mean(SWE)) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = anomaly)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  scale_fill_scico(palette = 'broc',
                   direction = -1,
                   limits = c(-1300, 1300)) +
  transition_states(year) +
  theme_void()

cera_dat %>%
  group_by(x, y) %>%
  mutate(anomaly = SWE - mean(SWE)) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = anomaly)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  scale_fill_scico(palette = 'broc',
                   direction = -1,
                   limits = c(-130, 130)) +
  transition_states(year) +
  theme_void()
```



So there's a clear bias here. As we see below, the mean of the observations is well higher than it should be. Looks like the simulation underpredicts snow -- likely because of all the small-scale topographic influences that CESM can't resolve.


~~~~~~~~~~~~~~~~~~~~~


```{r}
knitr::knit_exit()
```






# Teleconnections

### Sea Surface Temperatures

To cite use of dataset: Boyin Huang, Peter W. Thorne, Viva F. Banzon, Tim Boyer, Gennady Chepurin, Jay H. Lawrimore, Matthew J. Menne, Thomas M. Smith, Russell S. Vose, and Huai-Min Zhang (2017): NOAA Extended Reconstructed Sea Surface Temperature (ERSST), Version 5. [indicate subset used]. NOAA National Centers for Environmental Information. doi:10.7289/V5T72FNM [access date].
Please note: If you acquire NOAA_ERSST_V5 data products from PSD, we ask that you acknowledge us in your use of the data. This may be done by including text such as NOAA_ERSST_V5 data provided by the NOAA/OAR/ESRL PSD, Boulder, Colorado, USA, from their Web site at https://www.esrl.noaa.gov/psd/ in any documents or publications using these data. We would also appreciate receiving a copy of the relevant publications. This will help PSD to justify keeping the NOAA_ERSST_V5 data set freely available online in the future. Thank you!

```{r, warning = FALSE}
sst_mean <- mean(brick('../data/sst.mon.ltm.1981-2010.nc', varname = 'sst')[[1:3]])

sst_brick <- brick('../data/sst.mnmean.nc', varname = 'sst')

time <- getZ(sst_brick)
id <- which(time >= as.Date('1982-01-01') & time <= as.Date('2017-03-01') & str_detect(time, c('-01-', '-02-', '-03-')))

sst_jfm <- subset(sst_brick, id) %>%
  stackApply(rep(1:36, each = 3), 'mean') %>% 
  `-`(sst_mean) %>% 
  crop(extent(c(-1, 359, -75, 75))) %>%
  disaggregate(fact = 2, method = 'bilinear')
```

```{r, warning = FALSE}
sst_cor <- map(1:nmodes, ~calc(sst_jfm, fun=function(x) cor(c(x), filter(prism_patterns[[.,2]]$amplitude))) %>%
  brick() %>%
  `names<-`(paste0('PC', 1:nmodes)))
```


```{r, warning = FALSE}
fdr <- function(x, k) {
  if (any(is.na(c(x)))) {
    NA
  }
  else {
    p.adjust(cor.test(c(x), prism_patterns[[k,2]]$amplitude)$p.value, method = 'BH')
  }
}

sst_sig <- map(1:nmodes, ~   calc(sst_jfm, fun=function(x) fdr(x, k = .))) %>%
    brick() %>%
  `names<-`(paste0('PC', 1:nmodes))

sst_sig[sst_sig > 0.05] <- NA
sst_sig_pts <- raster::as.data.frame(sst_sig, xy = TRUE, long = TRUE) %>%
  rename(eof = layer) %>%
  filter(!is.na(value))
```

```{r,  echo = FALSE}
sst_cor %>% 
  as.data.frame(xy = T, na.rm = T) %>%
  gather(eof, value, starts_with('PC')) %>%
  #  filter(value > .1 | value < -.1) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = value)) +
  geom_point(data = sst_sig_pts, shape = '.', alpha = .075) +
  facet_wrap(~eof, nrow = 3) +
  scale_fill_distiller(name = 'Correlation', palette = 'RdBu', limits = c(-1,1)) +
  coord_quickmap(ylim = c(-75,75), expand = FALSE) +
  geom_polygon(data = world, aes(x = long, y = lat, group = group)) +
  labs(title = 'Snow teleconnections', 
       subtitle = 'PC correlation to JFM sea surface temperature',
       x = 'Longitude', y = 'Latitude') +
  theme_bw()
  
#ggsave('sst_telecon_cov.png')
```

```{r,  echo = FALSE}
sst_cor %>% 
  as.data.frame(xy = T, na.rm = T) %>%
  gather(eof, value, starts_with('PC')) %>%
  #  filter(value > .1 | value < -.1) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = value)) +
  geom_point(data = sst_sig_pts, shape = '.', alpha = .075) +
  facet_wrap(~eof, nrow = 3) +
  scale_fill_distiller(name = 'Correlation', palette = 'RdBu', limits = c(-1,1)) +
  coord_quickmap(ylim = c(-75,75), expand = FALSE) +
  geom_polygon(data = world, aes(x = long, y = lat, group = group)) +
  labs(title = 'Snow teleconnections', 
       subtitle = 'PC correlation to JFM sea surface temperature',
       x = 'Longitude', y = 'Latitude') +
  theme_bw()
  
#ggsave('sst_telecon_cov.png')
```

### Geopotential

```{r}
geop_jfm <- brick('../data/adaptor.mars.internal-1584737536.594777-6445-11-8d0fcc69-bd7d-40e2-a423-cf86c741ac79.nc')[[-(1:3)]] %>%
   stackApply(rep(1:36, each = 3), 'mean') %>%
    `-`(., mean(.)) %>%
  aggregate(fact = 4, method = 'bilinear')
```

```{r, warning = FALSE, message = FALSE}
geop_cor <- map(1:nmodes, ~calc(geop_jfm, fun=function(x) cor(c(x), prism_patterns[[.,2]]$amplitude))) %>%
  brick()%>%
  `names<-`(paste0('PC', 1:nmodes))


geop_sig <- map(1:nmodes, ~calc(geop_jfm, fun=function(x) fdr(x, k = .))) %>%
  brick() %>%
  `names<-`(paste0('PC', 1:nmodes))


geop_sig[geop_sig > 0.05] <- NA
geop_sig_pts <- raster::as.data.frame(geop_sig, xy = TRUE, long = TRUE) %>%
  rename(eof = layer) %>%
  filter(!is.na(value))
```

```{r, echo = FALSE}
geop_cor %>% 
  as.data.frame(xy = T, na.rm = T) %>%
  gather(eof, value, starts_with('PC')) %>%
  #  filter(value > .1 | value < -.1) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = value)) +
    geom_polygon(data = world, aes(x = long, y = lat, group = group), alpha = .25) +
  geom_point(data = geop_sig_pts, shape = '.', alpha = .075) +
  facet_wrap(~eof, nrow = 3) +
  scale_fill_distiller(name = 'Correlation', palette = 'RdBu', limits = c(-1,1)) +
  coord_quickmap(ylim = c(-75,75), expand = FALSE) +
  labs(title = 'Snow teleconnections', 
       subtitle = 'PC correlation to JFM 500mb geopotential height',
       x = 'Longitude', y = 'Latitude') +
  theme_bw()
  
#ggsave('geop_telecon_cov.png')
```

```{r, echo = FALSE}
geop_cor %>% 
  as.data.frame(xy = T, na.rm = T) %>%
  gather(eof, value, starts_with('PC')) %>%
  #  filter(value > .1 | value < -.1) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = value)) +
    geom_polygon(data = world, aes(x = long, y = lat, group = group), alpha = .25) +
  geom_point(data = geop_sig_pts, shape = '.', alpha = .075) +
  facet_wrap(~eof, nrow = 3) +
  scale_fill_distiller(name = 'Correlation', palette = 'RdBu', limits = c(-1,1)) +
  coord_quickmap(ylim = c(-75,75), expand = FALSE) +
  labs(title = 'Snow teleconnections', 
       subtitle = 'PC correlation to JFM 500mb geopotential height',
       x = 'Longitude', y = 'Latitude') +
  theme_bw()
  
#ggsave('geop_telecon_cov.png')
```


## Interpretation

```{r, echo = FALSE}
a <- prism_patterns%>%
    dplyr::select(-amplitudes) %>%
    unnest(patterns) %>%
    mutate(EOF = paste0('EOF', PC)) %>%
  left_join(prism_climatology) %>%
  ggplot() +
      geom_raster(aes(x, y, fill = weight/swe_sd)) +
      geom_sf(data = states_wus, fill = NA, color = 'black') +
      facet_wrap(~EOF, ncol = 1) +
      scale_fill_scico(name = 'weight/sdev', palette = 'vik', direction = 1, limits = c(-1, 1) ) +
      theme_void()+
  theme(legend.position = 'bottom')


b<- sst_cor %>% 
  as.data.frame(xy = T, na.rm = T) %>%
  gather(eof, value, starts_with('PC')) %>%
  #  filter(value > .1 | value < -.1) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = value)) +
  geom_point(data = sst_sig_pts, shape = '.', alpha = .075) +
  facet_wrap(~eof, ncol = 1) +
  scale_fill_distiller(name = 'Corr.', palette = 'RdBu', limits = c(-1,1)) +
  coord_quickmap(ylim = c(-75,75), expand = FALSE) +
  geom_polygon(data = world, aes(x = long, y = lat, group = group)) +
  labs(x = 'Longitude', y = 'Latitude') +
  theme_bw() +
  theme(legend.position = 'bottom')


c<-geop_cor %>% 
  as.data.frame(xy = T, na.rm = T) %>%
  gather(eof, value, starts_with('PC')) %>%
  #  filter(value > .1 | value < -.1) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = value)) +
    geom_polygon(data = world, aes(x = long, y = lat, group = group), alpha = .25) +
  geom_point(data = geop_sig_pts, shape = '.', alpha = .075) +
  facet_wrap(~eof, ncol = 1) +
  scale_fill_distiller(name = 'Corr.', palette = 'RdBu', limits = c(-1,1)) +
  coord_quickmap(ylim = c(-75,75), expand = FALSE) +
  labs(x = 'Longitude', y = 'Latitude') +
  theme_bw()+
  theme(legend.position = 'bottom')

#library(patchwork)  
(a|b|c) + plot_layout(widths = c(1, 1,1)) + plot_annotation(tag_levels = 'A')
ggsave('snow_teleconnections.png', height =8.5, width = 11)
#ggsave('snow_telecon_cov.png')
```
```{r}
get_eofs(prism_dat, prism_pcs, prism_eigs, 4) %>%
    left_join(prism_climatology, by = c("x", "y")) %>%
ggplot() +
    geom_raster(aes(x, y, fill = weight/swe_sd)) +
    geom_sf(data = states_wus, fill = NA, color = 'black') +
    facet_wrap(~EOF) +
    scale_fill_scico(palette = 'vik', direction = 1, limits = c(-1, 1)) +
    theme_void()+
    ggtitle('prism unrotated')

get_eofs(prism_dat, prism_pcs, prism_eigs, k = 4) %>%
    left_join(prism_climatology, by = c("x", "y")) %>%
ggplot() +
    geom_raster(aes(x, y, fill = weight_rotated/swe_sd)) +
    geom_sf(data = states_wus, fill = NA, color = 'black') +
    facet_wrap(~EOF) +
    scale_fill_scico(palette = 'vik', direction = 1, limits = c(-1, 1)) +
    theme_void()+
    ggtitle('prism rotated')
```


```{r}
get_eofs(prism_dat, prism_pcs, prism_eigs, 6) %>%
    left_join(prism_climatology, by = c("x", "y")) %>%
ggplot() +
    geom_raster(aes(x, y, fill = weight/swe_sd)) +
    geom_sf(data = states_wus, fill = NA, color = 'black') +
    facet_wrap(~EOF) +
    scale_fill_scico(palette = 'vik', direction = 1, limits = c(-1, 1)) +
    theme_void()+
    ggtitle('prism unrotated')

get_eofs(prism_dat, prism_pcs, prism_eigs, k = 6) %>%
    left_join(prism_climatology, by = c("x", "y")) %>%
ggplot() +
    geom_raster(aes(x, y, fill = weight_rotated/swe_sd)) +
    geom_sf(data = states_wus, fill = NA, color = 'black') +
    facet_wrap(~EOF) +
    scale_fill_scico(palette = 'vik', direction = 1, limits = c(-1, 1)) +
    theme_void()+
    ggtitle('prism rotated')
```

```{r}
get_eofs(livneh_dat, livneh_pcs, livneh_eigs, 9) %>%
    left_join(livneh_climatology, by = c("x", "y")) %>%
ggplot() +
    geom_raster(aes(x, y, fill = weight/swe_sd)) +
    geom_sf(data = states_wus, fill = NA, color = 'black') +
    facet_wrap(~EOF) +
    scale_fill_scico(palette = 'vik', direction = 1, limits = c(-1, 1)) +
    theme_void()+
    ggtitle('livneh unrotated')



get_eofs(livneh_dat, livneh_pcs, livneh_eigs, 5) %>%
    left_join(livneh_climatology, by = c("x", "y")) %>%
ggplot() +
    geom_raster(aes(x, y, fill = weight_rotated/swe_sd)) +
    geom_sf(data = states_wus, fill = NA, color = 'black') +
    facet_wrap(~EOF) +
   scale_fill_scico(palette = 'vik', direction = 1, limits = c(-480, 480)) +
    theme_void()+
    ggtitle('livneh rotated')

get_eofs(livneh_dat, livneh_pcs, livneh_eigs, 8) %>% 
    left_join(livneh_climatology, by = c("x", "y")) %>%
ggplot() +
    geom_raster(aes(x, y, fill = weight_rotated)) +
    geom_sf(data = states_wus, fill = NA, color = 'black') +
    facet_wrap(~EOF, ncol = 4) +
    scale_fill_scico(palette = 'vik', direction = 1, limits = c(-480, 480)) +
    theme_void()+
    ggtitle('livneh rotated')
```


```{r}
library(rsoi)
pdo <- download_pdo() %>%
  filter(Month %in% c('Jan', 'Feb', 'Mar') & Year >= 1982 & Year <= 2017) %>%
  group_by(Year) %>%
  summarise(PDO = mean(PDO))

nao <- download_nao() %>%
   filter(Month %in% c('Jan', 'Feb', 'Mar') & Year >= 1982 & Year <= 2017) %>%
  group_by(Year) %>%
  summarise(NAO = mean(NAO))

ao <- download_ao() %>%
   filter(Month %in% c('Jan', 'Feb', 'Mar') & Year >= 1982 & Year <= 2017) %>%
  group_by(Year) %>%
  summarise(AO = mean(AO))

enso <- download_enso() %>%
   filter(Month %in% c('Jan', 'Feb', 'Mar') & Year >= 1982 & Year <= 2017) %>%
  group_by(Year) %>%
  summarise(ONI = mean(ONI), SOI = mean(SOI), NPGO = mean(NPGO))

indices <- left_join(enso, pdo) %>%
  left_join(nao) %>%
  left_join(ao)
```

```{r}
indices %>%
  gather(index, value, ONI:NAO) %>%
  ggplot(aes(Year, value)) +
  geom_line() +
  facet_wrap(~index)
plot_amps(prism_patterns)


cor(prism_patterns[[1,2]]$amplitude, indices$ONI)
cor(prism_patterns[[1,2]]$amplitude, indices$SOI)
cor(prism_patterns[[1,2]]$amplitude, indices$NPGO)
cor(prism_patterns[[1,2]]$amplitude, indices$PDO)
cor(prism_patterns[[1,2]]$amplitude, indices$NAO)
cor(prism_patterns[[1,2]]$amplitude, indices$AO)
5
cor(prism_patterns[[2,2]]$amplitude, indices$ONI)
cor(prism_patterns[[2,2]]$amplitude, indices$SOI)
cor(prism_patterns[[2,2]]$amplitude, indices$NPGO)
cor(prism_patterns[[2,2]]$amplitude, indices$PDO)
cor(prism_patterns[[2,2]]$amplitude, indices$NAO)
cor(prism_patterns[[2,2]]$amplitude, indices$AO)
```


```{r}
phase <- download_enso() %>%
   filter(Month %in% c('Jan', 'Feb', 'Mar') & Year >= 1982 & Year <= 2017) %>%
  group_by(Year) %>%
    dplyr::select(phase) %>%
  count(phase) %>%
  filter(n == max(n)) %>%
  ungroup %>%
  rename(year = Year)

bind_rows(prism_patterns$amplitudes, .id = 'pc') %>%
  left_join(phase) %>%
  ggplot(aes(amplitude)) +
  geom_density(aes(fill = phase), alpha = .7)+
  facet_wrap(~pc)
  ggplot(aes(pc1,pc2, color = phase)) +
 # geom_path() +
  geom_point() + coord_equal()
```

## Livneh


```{r}
livneh_climatology <- livneh_dat %>% 
  group_by(x, y) %>%
  summarise(swe_mean = mean(SWE),
            swe_sd = sd(SWE))
```


```{r, echo = FALSE, fig.asp = .8}
ggplot(livneh_climatology) +
  geom_raster(aes(x, y, fill = swe_mean)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  scale_fill_scico(palette = 'davos', direction = -1) +
  ggtitle('Mean March SWE, 1901-2010', 'CERA-20C Reanalysis')

ggplot(livneh_climatology) +
  geom_raster(aes(x, y, fill = swe_sd)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  scale_fill_scico(palette = 'davos', direction = -1)+
  ggtitle('Standard Deviation of March SWE, 1901-2010', 'Livneh')
```



```{r, fig.asp = 0.75, echo = FALSE}
livneh_dat %>% 
  semi_join(livneh_mask) %>%
  get_pcs() %>%
  get_eigenvalues() %>% 
  plot_scree(8)
```
Lets start by truncating at 4. Extract the pc amplitude time series and EOF spatial patterns for the leading 6 modes.

```{r}
nmodes <- 5
```

```{r, fig.asp = 1}
plot_eofs(get_patterns(livneh_dat, k = nmodes, rotate = FALSE), 'vik', scaled = FALSE)
plot_eofs(get_patterns(livneh_dat, k = nmodes, rotate = TRUE), 'vik', scaled = FALSE)
plot_eofs(get_patterns(livneh_dat, k = nmodes, rotate = FALSE), 'vik', scaled = TRUE)
plot_eofs(get_patterns(livneh_dat, k = nmodes, rotate = TRUE), 'vik', scaled = TRUE)
```

Run the principal components analysis.
```{r}
livneh_patterns <- get_patterns(livneh_dat, k = 5, rotate = TRUE)
```

```{r, echo = FALSE}
plot_amps(livneh_patterns) + geom_vline(xintercept = 2004, color = 'red')#geom_vline(xintercept = c(1983, 1998, 1992, 2010, 1987)) + geom_hline(yintercept = 0, linetype = 2) + geom_vline(xintercept = c(2011, 1989, 2000, 2008), color = 'red')
```


Plot the eofs. 
```{r echo = FALSE, fig.asp = 1}
plot_eofs(livneh_patterns, 'vik', scaled = FALSE) 
plot_eofs(livneh_patterns, 'vik', scaled = TRUE) 
plot_eofs(prism_patterns, 'vik', scaled = TRUE) 

```


```{r, echo = FALSE}
plot_amps(livneh_patterns) + geom_vline(xintercept = c(1983, 1998,1992, 1931, 1987))
```

```{r fig.asp = 1.2, echo = FALSE}
#plot_eof(livneh_patterns, 'vik')

livneh_patterns%>%
    dplyr::select(-amplitudes) %>%
    unnest(patterns) %>%
    mutate(EOF = paste0('EOF', PC)) %>%
  left_join(livneh_climatology) %>%
  ggplot() +
      geom_raster(aes(x, y, fill = weight)) +
      geom_sf(data = states_wus, fill = NA, color = 'black') +
      facet_wrap(~EOF) +
      scale_fill_scico(palette = 'broc', direction = -1, limits = c(-1, 1) ) +
      theme_void()+
      ggtitle('Observed March SWE EOFS')
```

```{r}
pdo <- download_pdo() %>%
  filter(Month %in% c('Jan', 'Feb', 'Mar') & Year >= 1915 & Year <= 2011) %>%
  group_by(Year) %>%
  summarise(PDO = mean(PDO))

nao <- download_nao() %>%
   filter(Month %in% c('Jan', 'Feb', 'Mar') & Year >= 1915 & Year <= 2011) %>%
  group_by(Year) %>%
  summarise(NAO = mean(NAO))

ao <- download_ao() %>%
   filter(Month %in% c('Jan', 'Feb', 'Mar') & Year >= 1915 & Year <= 2011) %>%
  group_by(Year) %>%
  summarise(AO = mean(AO))

enso <- download_enso() %>%
   filter(Month %in% c('Jan', 'Feb', 'Mar') & Year >= 1915 & Year <= 2011) %>%
  group_by(Year) %>%
  summarise(ONI = mean(ONI), SOI = mean(SOI), NPGO = mean(NPGO))

indices <- left_join(enso, pdo) %>%
  left_join(nao) %>%
  left_join(ao) %>%
  rename(year = Year)

phase <- download_enso() %>%
   filter(Month %in% c('Jan', 'Feb', 'Mar') & Year >= 1915 & Year <= 2011) %>%
  group_by(Year) %>%
    dplyr::select(phase) %>%
  count(phase) %>%
  filter(n == max(n)) %>%
  ungroup %>%
  rename(year = Year)
```

```{r}

bind_rows(livneh_patterns$amplitudes, .id = 'pc') %>%
  left_join(phase) %>%
  filter(year >=1952) %>%
  ggplot(aes(amplitude)) +
  geom_density(aes(fill = phase), alpha = .7)+
  facet_wrap(~pc)

bind_rows(livneh_patterns$amplitudes, .id = 'pc') %>%
  left_join(indices) %>%
  filter(year >=1952) %>%
  gather(index, value, ONI:AO) %>%
  group_by(pc, index) %>%
  summarise(correlation = cor(amplitude, value)) %>%
  ggplot(aes(pc, index)) +
  geom_tile(aes(fill = correlation)) +
  scale_fill_distiller(palette = 'RdBu', limits = c(-1, 1)) +
  coord_equal()

bind_rows(livneh_patterns$amplitudes, .id = 'pc') %>%
  left_join(indices) %>%
  filter(year >=1952) %>%
  gather(index, value, ONI:AO) %>%
  group_by(pc, index) %>%
  summarise(correlation = cor(amplitude, value)) %>%
  ggplot(aes(pc, index)) +
  geom_tile(aes(fill = abs(correlation))) +
  scale_fill_viridis_c()+
  coord_equal()
```

