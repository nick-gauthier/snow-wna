---
title: "Downscaling Snowpack variability in western North America over the common era"
subtitle: "Models and Observations"
author: "Nick Gauthier"
date: "Last knit on: `r Sys.Date()`"
output:
  tufte::tufte_html: default
  tufte::tufte_handout:
    citation_package: natbib
    latex_engine: xelatex
  tufte::tufte_book:
    citation_package: natbib
    latex_engine: xelatex
link-citations: yes
---

Analysis of simulated and observed snow water equivalent (SWE) dynamics in western North America over the Common Era.

# Setup

## Packages

Import the packages required for this analysis.

```{r setup, message = FALSE, warning = FALSE}
library(raster) # processing raster data
library(nFactors)
library(tidyverse) # data manipulation and visualization
library(mgcv) # flexible nonlinear regression models
library(furrr) # parallel processing
library(broom) # tidying model objects
library(mgcv)
library(remote)
```

Plotting packages

```{r}
library(sf) # shapefiles and plotting
library(gganimate) # animated gifs
library(ggridges) # ridge plots
```

## Geographic Data

Define a study area to constrain all computaitons.
```{r}
bbox <- extent(c(-125, -104, 33, 49))
  ```

```{r, echo = FALSE}
# not shown, download state boundary files
state_names <- c('arizona', 'new mexico', 'colorado', 
                 'california', 'utah', 'nevada', 
                 'oregon', 'washington', 'idaho',
                 'wyoming', 'montana')

states_wus <- maps::map('state', regions = state_names, 
                    fill = TRUE, plot = FALSE) %>% st_as_sf
```

Import the snow observation data from https://nsidc.org/data/nsidc-0719.^[What's up with this warning message? long_name=CRS definition
spatial_ref=GEOGCS["NAD83",DATUM["North_American_Datum_1983",SPHEROID["GRS 1980",6378137,298.257222101,AUTHORITY["EPSG","7019"]],AUTHORITY["EPSG","6269"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.01745329251994328,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4269"]]
GeoTransform=-125.0208 0.04166662697178698 0 49.9375 0 -0.04166662697178698]. First define a function to extract the map for April 1st from each annual file, then run it on the SWE and snow depth data.

```{r}
preprocess <- function(x, var, flip = FALSE, regrid = FALSE, monthly = FALSE) {
  maps <- brick(x, varname = var)

  indices <- getZ(maps) %>% # find the index for April 1st
    {if(monthly) str_detect(., '-03-') else str_detect(., '-04-01')} %>%
    which()
  
  subset(maps, indices) %>%
    {if(flip) rotate(.) else .} %>%
    crop(bbox) %>%
    {if(regrid) aggregate(., fact = 2, na.rm = TRUE) else .} # resample to lower res to speed up analysis
}
```

```{r}
preprocess_prism <- function(x, var = 'SWE'){
  maps <- brick(x, varname = var)

  indices <- getZ(maps) %>% # find the index for April 1st
    str_detect('-03-') %>%
    which()
  
  subset(maps, indices) %>%
    crop(bbox) %>%
    mean() %>%
    aggregate(fact = 3, na.rm = TRUE) # resample to lower res to speed up analysis
}
```

```{r}
plan(multisession)
```


```{r message=FALSE,warning=FALSE}
# import SWE data
prism <- list.files('data', pattern = 'SWE_Depth', full.names = TRUE) %>%
  future_map(preprocess_prism, var = 'SWE') %>%
  brick() %>%
  setNames(1982:2017)
```

```{r}
ccsm <- preprocess('data/snw_LImon_CCSM4_past1000_r1i1p1_085001-185012.nc', 
                   var = 'snw', 
                   flip = TRUE, 
                   monthly = TRUE)
```

```{r, warning = FALSE}
cera <- map(1:10, 
            ~(brick('data/CERA-20C_snow.nc', varname = 'rsn', level = .) *
                brick('data/CERA-20C_snow.nc', varname = 'sd', level = .)) %>%
              projectRaster(ccsm)) %>%
              reduce(`+`) %>%
              `/`(10) %>%
  crop(bbox)
```

```{r}
area_obs <- raster::area(prism) %>%
    as.data.frame(xy = TRUE, na.rm = TRUE, long = TRUE) %>%
  select(-layer) %>%
  rename(area = value)

ccsm_areas <- raster::area(ccsm) %>%
  as.data.frame(xy = TRUE, na.rm = TRUE) %>%
  rename(area = layer)
```

## Preprocessing

```{r}
snow_only <- function(dat){
  dat %>%
      group_by(x, y) %>%
  mutate(test = all(near(SWE, 0) | is.na(SWE))) %>%
  filter(test == FALSE) %>%
  ungroup() %>%
  select(-test)
}
```

Turn all the rasters into data frames and join.
```{r}
prism_dat <- prism %>%
  as.data.frame(xy = TRUE, na.rm = TRUE, long = TRUE) %>%
  mutate(year = round(parse_number(layer))) %>%
  rename(SWE = value) %>%
  select(-layer) %>%
  left_join(area_obs, by = c('x', 'y')) %>%
  snow_only()
```

```{r}
cera_dat <- cera %>%
  as.data.frame(xy = TRUE, na.rm = TRUE, long = TRUE) %>%
  mutate(year = round(parse_number(layer))) %>%
  rename(SWE = value) %>%
  select(-layer) %>%
  snow_only()
```

```{r}
ccsm_dat <- ccsm %>%
  as.data.frame(xy = TRUE, na.rm = TRUE, long = TRUE) %>%
  mutate(year = str_sub(layer, 2) %>% parse_number() %>% round) %>%
  rename(SWE = value) %>%
  select(-layer) %>%
  left_join(ccsm_areas, by = c('x', 'y')) %>%
  snow_only()
```

# Visualization


What's the climatic mean April 1st SWE for the observations and simulations?
```{r, echo = FALSE, warning = FALSE}
library(scico)
prism_dat %>%
  group_by(x, y) %>%
  summarise(SWE = mean(SWE))%>%
  ggplot() +
  geom_raster(aes(x, y, fill = SWE)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  #scale_fill_distiller(palette = 'PuBu', direction = 1) +
  scale_fill_scico(palette = 'davos', direction = -1) +
  ggtitle('Observed mean April 1st SWE, 1982-2017', 'PRISM')
```

```{r}
cera_dat %>%
  group_by(x, y) %>%
  summarise(SWE = mean(SWE))%>%
  ggplot() +
  geom_raster(aes(x, y, fill = SWE)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  #scale_fill_distiller(palette = 'PuBu', direction = 1) +
  scale_fill_scico(palette = 'davos', direction = -1) +
  ggtitle('Simulated mean March SWE, 1900-2010', 'PRISM')
```


To what extent is this mistmatch due to bias or scale effects? Test by resampling the observations to the CESM LME grid.

```{r, echo = FALSE}
mean_swe_cera <- cera_dat %>%
  filter(year >= 1982) %>%
  group_by(x, y) %>%
  summarise(sim = mean(SWE))

prism_resamp <- prism %>%
  subset(1:29) %>%
  mean %>%
  resample(ccsm) %>%
  as.data.frame(xy = TRUE, na.rm = TRUE) %>%
  rename(obs = layer)

left_join(prism_resamp, mean_swe_cera, by = c('x', 'y')) %>%
  gather(type, SWE, 3:4) %>%
ggplot() +
  geom_raster(aes(x, y, fill = SWE)) +
  geom_sf(data = states_wus, fill = NA, color = 'white') +
  theme_void() +
  facet_wrap(~type) +
    scale_fill_scico(palette = 'davos', direction = -1) +
  ggtitle('Observed vs Simulated mean March SWE', '1982-2010')
```


Look at how SWE has varied over time and space.

```{r animation, echo = FALSE, warning=FALSE,cache = TRUE}
prism_dat %>%
  ggplot() +
  geom_raster(aes(x, y, fill = SWE)) +
    scale_fill_scico(palette = 'davos', direction = -1) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  ggtitle("Snow Water Equivalent", "March, {closest_state}") +
  transition_states(year)
```

```{r cera_animation, echo = FALSE, warning=FALSE,cache = TRUE}
cera_dat %>%
  ggplot() +
  geom_raster(aes(x, y, fill = SWE)) +
    scale_fill_scico(palette = 'davos', direction = -1) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  ggtitle("Snow Water Equivalent", "March, {closest_state}") +
  transition_states(year)
```

```{r, echo = FALSE}
 prism_dat %>%
  group_by(x, y) %>%
  mutate(anomaly = SWE - mean(SWE)) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = anomaly)) +
    geom_sf(data = states_wus, fill = NA, color = 'black') +
  #scale_fill_distiller(palette = 'RdBu', limits = c(-1300, 1300)) +
  scale_fill_scico(palette = 'broc', direction = -1, limits = c(-1300, 1300)) +
  transition_states(year) +
  theme_void()
```

```{r, echo = FALSE}
 cera_dat %>%
  group_by(x, y) %>%
  mutate(anomaly = SWE - mean(SWE)) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = anomaly)) +
    geom_sf(data = states_wus, fill = NA, color = 'black') +
  #scale_fill_distiller(palette = 'RdBu', limits = c(-1300, 1300)) +
  scale_fill_scico(palette = 'broc', direction = -1, limits = c(-130, 130)) +
  transition_states(year) +
  theme_void()
```

Some aggregate statistics. Is this the right way to aggregate?

```{r}
obs_agg <- prism_dat %>%
  filter(SWE > 0) %>%
  group_by(year) %>%
  summarise(SWE = sum(SWE * area), # units in megaliters (?)
            area = sum(area))
```

How has total SWE varied over the observational period?
```{r, echo = FALSE, fig.fullwidth = TRUE}
ggplot(obs_agg, aes(year, SWE)) +
  #geom_vline(xintercept = 2015, color = 'red', linetype = 2) +
  geom_col(aes(fill = SWE)) +
  scale_fill_viridis_c(guide = FALSE) +
  theme_minimal() +
  ggtitle('Total SWE over western North America')
```

```{r, echo = FALSE, fig.fullwidth = TRUE}
ggplot(obs_agg, aes(year, SWE)) +
  #geom_vline(xintercept = 2015, color = 'red', linetype = 2) +
  geom_point(aes(color = SWE)) +
  scale_color_viridis_c(guide = FALSE) +
  geom_smooth(method = 'lm') +
  theme_minimal() +
  ggtitle('Total SWE over western North America')
```

What about total area covered?
```{r, echo = FALSE, fig.fullwidth = TRUE}
ggplot(obs_agg, aes(year, area)) +
  geom_col(aes(fill = area)) +
  scale_fill_viridis_c(guide = FALSE) +
  theme_minimal() +
  ggtitle('Total snow area over western North America')
```

```{r, echo = FALSE}
ggplot(obs_agg, aes(area, SWE)) +
  geom_point(aes(color = year), size = 2.5) +
  scale_color_viridis_c() +
  geom_smooth(method = 'lm') +
  theme_minimal() +
  labs(x = 'Area (km2)', title = 'Relationship between total SWE and snow extent')
```


```{r animation_ccsm, echo = FALSE, cache = TRUE}
ccsm_dat %>%
  filter(year < 1000) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = SWE)) +
  geom_sf(data = states_wus, fill = NA, colour = 'white') +
  scale_fill_viridis_c() +
  coord_sf()+
  theme_void() +
  ggtitle("Simulated Snow Water Equivalent", "April 1st, {closest_state}") +
  transition_states(year)
```



```{r}
ccsm_agg <- ccsm_dat %>%
  group_by(year) %>%
  summarise(SWE = sum(SWE * area, na.rm = TRUE)) %>%
  mutate(avg = zoo::rollmean(SWE, k = 100, na.pad = TRUE))
```


```{r, echo = FALSE, warning = FALSE}
ggplot(ccsm_agg, aes(year, SWE)) +
  geom_line(alpha = .3) +
  #geom_point(aes(color = SWE)) +
    geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs", k = 30)) +
  geom_line(aes(y = avg), size = 1.2) +
  scale_color_viridis_c(guide = FALSE) +
  theme_minimal() +
  ggtitle('Simulated SWE over the Last Millennium')
```

So there's a clear bias here. As we see below, the mean of the observations is well higher than it should be. Looks like the simulation underpredicts snow -- likely because of all the small-scale topographic influences that CESM can't resolve.

```{r}
mod_avg <- obs_agg %>% 
  summarise(SWE = mean(SWE)) %>%
  pull(SWE)
```



```{r, echo = FALSE, fig.width = 3.5, fig.height = 8}
ccsm_agg %>%
  mutate(period = floor((year / 30)) * 30) %>%
  ggplot(aes(SWE, period, group = period)) +
  geom_density_ridges(fill = 'lightgrey') +
  #ggridges::geom_density_ridges_gradient(stat = 'density', scale = 1.5)+
  #scale_fill_viridis_c(guide = F) +
  geom_vline(xintercept= c(mod_avg), linetype = 2) +
  ggridges::theme_ridges(grid = FALSE, center_axis_labels = TRUE)
```


Let's compare the observations and simulation directly.


# PCA

```{r}
calc_pcs <- function(dat, scale = TRUE){
  dat %>%
    spread(year, SWE) %>%
    select(-x, -y) %>%
    t() %>%
    prcomp(scale. = FALSE)
}
```

```{r}
cera %>% getValues()
```


```{r}
 recons <- lapply(seq(nlayers(x)), function(i) {
        rowSums(t(as.matrix(pca$loadings[, 1:k])[i, ] * t(pca$scores[, 
            1:k]))) + pca$center[i]
 })

prism_pca$center
library(telefit)
cca.predict

eof
library(wql)
eof
transformeR::gridFromPCA
library(downscaleR)
```


```{r}
prism_pca <- prism_dat %>%
  select(-area) %>%
  calc_pcs()

sim_pca <- ccsm_dat %>% 
  select(-area) %>% 
  calc_pcs()

cera_pca <- calc_pcs(cera_dat)
```


```{r}
area_weight <- function(x){
  names_x <- names(x)
  x %>%
    init('y') %>% # get a map of latitudes
    `*`(pi/180) %>% # convert to radians
    cos %>% # cosine
    sqrt %>%
    `*`(x) %>%
    `names<-`(names_x)
}
```

Autocorrelation in the observed time series may bias our assessment of the principal components. Define a function to calculate the effective number of observations given the sample autocorrelation. 
```{R}
n_effective <- function(x){
  n <- nlayers(x)
  x %>%
    area_weight %>%
    as.data.frame(na.rm = TRUE) %>%
    filter_all(any_vars(floor(.) != 0)) %>%
    t %>%
    as_tibble %>%
    gather(cell, value) %>%
    nest(data = c(value)) %>% 
    mutate(rho = map_dbl(data, ~cor(.$value, lag(.$value), use = 'comp'))) %>%
    remove_missing() %>%
    mutate(effective_n = n * (1 - rho^2) / (1 + rho^2)) %>% # from Bretherton et al 1999
    summarise(mean(effective_n)) %>%
    pull
}
```

```{r}
get_eigs <- function(pc_object, raster){
  pc_object %>%
    tidy(matrix = 'pcs') %>%
    mutate(eigenvalues = std.dev ^ 2,
         error = sqrt(2 / n_effective(raster)),
         low =  eigenvalues * (1 - error) * 100 / sum(eigenvalues),
         hi = eigenvalues * (1 + error) * 100 / sum(eigenvalues),
         cumvar_line = hi + 0.02 * max(hi))
}
```

```{r, echo = FALSE}
prism_eigs <- get_eigs(prism_pca, prism)
sim_eigs <- get_eigs(sim_pca, ccsm)
cera_eigs <- get_eigs(cera_pca, cera)
```

```{r, echo = FALSE}
prism_eigs$eigenvalues %>%
  nScree() %>%
  plotnScree()

cera_eigs$eigenvalues %>%
  nScree() %>%
  plotnScree()

sim_eigs$eigenvalues %>%
  nScree() %>%
  plotnScree()
```


```{r}
test2 <- c(3.532, 1.985, .344, .074, .038, .027)

eigen_test <- function(lambdas, k, M, n){
nrank<- min(n - 1, M)

kstar <- M - k + 1
nk <- n - k + 1
mu <- (sqrt(nk - 0.5) + sqrt(kstar - 0.5))^2
sigma <- sqrt(mu) * (1 / sqrt(nk - 0.5) + 1 / sqrt(kstar - 0.5)) ^ (1/3)
alpha <- 46.4
beta <- (0.186 * sigma) / max(nk, kstar)
zeta <- (mu - 9.85 * sigma) / max(nk, kstar)
lambda_star <- lambdas[k] / ((1 / (nrank - k + 1)) * sum(lambdas[k:nrank]))


 (1- pgamma(((lambda_star - zeta) / beta), 46.4)) < 0.05
}


map_lgl(1:6, ~eigen_test(test2, k = ., M = 6, n = 31))


map_lgl(1:36, ~eigen_test(prism_eigs$eigenvalues, k = ., M = 17783, n = 36))

map_lgl(1:275, ~eigen_test(sim_eigs$eigenvalues, k = ., M = 276, n = 1001))
```


```{r}
plot_scree <- function(eigs, k){
  eigs %>% 
    mutate(separated = if_else(is.na(lag(low)), TRUE, hi < lag(low)),
           multiplet = as.factor(cumsum(separated))) %>%
    filter(PC <= 25) %>%
    ggplot(aes(x = PC, y = percent * 100)) +
    geom_linerange(aes(x = PC, ymin = low, ymax = hi), width = 0.4) +
    geom_point(size = 2, aes(color = multiplet)) + 
    geom_text(aes(x = PC, y = cumvar_line, label = paste0(round(cumulative * 100, 0), '%')), size = 2.5, vjust = 0) +
    labs(x = "Principal Component", y = "Normalized Eigenvalue") + 
    geom_vline(xintercept = k + .5, linetype = 2, color = 'red', alpha = .7) +
    theme_bw() + 
    guides(color = F) + 
    scale_x_continuous(breaks = seq(0, 25, 5))
}
```

```{r plot_variance_obs, echo = FALSE}
plot_scree(prism_eigs, 9)
plot_scree(cera_eigs, 9)
plot_scree(sim_eigs, 9)
```


## EOFs

```{r}
get_eofs <- function(dat, pca_object, eigenvalues, k){
  eofs <- pca_object %>% # calculate unrotated EOFs
    tidy(matrix = 'variables') %>%
    filter(PC <= k) %>%
    left_join(eigenvalues[1:2], by = 'PC') %>%
    mutate(weight = value * std.dev,
           EOF = as.character(PC)) %>%
    select(-std.dev,-value, -PC) 
  
  dat %>%
  spread(year, SWE) %>%
  mutate(column = 1:n()) %>%
  select(x, y, column) %>%
  full_join(eofs, by = 'column') %>%
      select(-column)
}

prism_eigs
```

```{r calc_eofs}
prism_eofs <- get_eofs(prism_dat, prism_pca, prism_eigs, 9)
sim_eofs <- get_eofs(ccsm_dat, sim_pca, sim_eigs, 9)
cera_eofs <- get_eofs(cera_dat, cera_pca, cera_eigs, 9)
```


```{r, echo = FALSE}
plot_eof <- function(eofs){
  eofs %>%
    mutate(EOF = paste0('EOF', EOF)) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = weight)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  facet_wrap(~EOF) +
  scale_fill_scico(palette = 'broc', direction = -1, limits = c(-1, 1)) +
  theme_void()+
  ggtitle('Observed April 1st SWE EOFS')
}
```


```{r}
plot_eof(prism_eofs)
plot_eof(cera_eofs)
plot_eof(sim_eofs)
```

So they're the same! next do a Canonical Correlation Analysis

# Coupled Pattern Analysis


## CCA


```{r}
get_pcs <- function(pc_object, k){
  tidy(pc_object, 'samples') %>%
    mutate(year = as.numeric(as.character(row))) %>%
    select(-row) %>%
    filter(PC <= k) %>%
    mutate(PC = as.character(PC)) %>%
    rename(amplitude = value)
}

pcs_prism <- get_pcs(prism_pca, 36)
pcs_cera <- get_pcs(cera_pca, 9)

tidy(prism_pca, 'samples')
```


```{r, echo = FALSE}
pcs_prism %>% 
  mutate(PC = paste0('PC', PC)) %>% 
ggplot(aes(year, amplitude)) +
  geom_line() +
  facet_wrap(~PC)

pcs_cera %>%
  mutate(PC = paste0('PC', PC)) %>% 
ggplot(aes(year, amplitude)) +
  geom_line() +
  facet_wrap(~PC)
```

```{r}
prism_scaler <- prism_dat %>%
  spread(year, SWE) %>%
  select(x, y) %>%
  mutate(avg = prism_pca$center, sdev = prism_pca$scale)

prism_recon <- pcs_prism %>%
  spread(year, amplitude) %>%
  left_join(prism_eofs, ., by = c('EOF' = 'PC')) %>%
  gather(year, amplitude, `1982`:`2017`) %>% ## change dates for cera
  mutate(SWE = weight * amplitude,
         year = as.numeric(year)) %>%
  group_by(x, y, year) %>%
  summarise(anomaly = sum(SWE)) %>%
  left_join(prism_scaler) %>%
  mutate(SWE =  anomaly * sdev + avg)
```

```{r}
prism_pca$center

prism_mean %>%
  ungroup %>%
  mutate(test = prism_pca$center)

plot(prism_mean$SWE_mean, prism_pca$center)



prism_pca$scale

```


```{r}
prism_recon %>%
filter(year <= 1987) %>% 
 # mutate(SWE = if_else(SWE < 0, 0, SWE)) %>%
ggplot() +
  geom_raster(aes(x, y, fill = SWE)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  facet_wrap(~year) +
  scale_fill_scico(palette = 'davos', direction = -1) +
  ggtitle('Observed mean April 1st SWE, 1982-2017', 'PRISM')

prism_dat %>%
    group_by(x, y) %>%
  mutate(SWE_mean = mean(SWE),
         anomaly = SWE - SWE_mean) %>%
filter(year <= 1987) %>%
ggplot() +
  geom_raster(aes(x, y, fill = SWE)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  facet_wrap(~year) +
  scale_fill_scico(palette = 'davos', direction = -1) +
  ggtitle('Observed mean April 1st SWE, 1982-2017', 'PRISM')
```


```{r}
prism_recon %>%
  left_join(prism_dat, by = c('x', 'y', 'year')) %>%
  mutate(error = SWE.x - SWE.y) %>%
filter(year <= 1987) %>%
ggplot() +
  geom_raster(aes(x, y, fill = error)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  facet_wrap(~year) +
  scale_fill_scico(palette = 'vik', direction = -1) +
  ggtitle('Observed mean April 1st SWE, 1982-2017', 'PRISM')
```

```{r}
library(mgcv)

t2 <- pcs_cera %>%
  filter(water_year >= 1982) %>% 
  select(water_year, PC1:PC9)

m1 <- pcs_prism %>%
  filter(water_year <= 2010) %>%
  select(PC5) %>%
  rename(target = PC5) %>%
  bind_cols(t2) %>%
  gam(target ~ s(PC1, k = 4) + s(PC2, k =5) + s(PC3, k = 4) + s(PC4, k = 4) + s(PC5, k = 4) + s(PC6, k = 4) + s(PC7, k = 4) + s(PC8, k = 4) + s(PC9, k = 4), data = ., method = 'REML', select = TRUE)
  

plot(m1)
summary(m1)
gam.check(m1)
```


```{r}
t1 <- pcs_prism %>%
  filter(water_year <= 2010) %>%
  select(PC1:PC9) %>%
  as.matrix() %>%
  scale()

t2 <- pcs_cera %>%
  filter(water_year >= 1982) %>% 
  select(PC1:PC9) %>%
  as.matrix() %>%
  scale()

can_cor<- cancor(t1, t2, xcenter = FALSE, ycenter = FALSE) # pcs already centered
```

```{r}
can_cor$cor
```

```{r}
cera_can <- cera_eofs %>%
  spread(PC, eof) %>%
  select(-column) %>%
  as.matrix() %>%
  `%*%`(can_cor$ycoef) %>%
    `colnames<-`(paste0('PC', 1:9)) %>%
  as_tibble()
  
prism_can <- prism_eofs %>%
  spread(PC, eof) %>%
  select(-column) %>%
  as.matrix() %>%
  `%*%`(can_cor$xcoef) %>%
  `colnames<-`(paste0('PC', 1:9)) %>%
  as_tibble()
```

```{r}
cera_dat %>%
  spread(year, SWE) %>%
  mutate(column = 1:n()) %>%
  select(x, y, column) %>%
  bind_cols(cera_can) %>%
  gather(pattern, value, PC1:PC9) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = value)) +
  #geom_sf(data = states_wus, fill = NA, color = 'black') +
  facet_wrap(~pattern) +
  scale_fill_distiller(palette = 'RdBu') +
  theme_void()+
  coord_quickmap() +
  ggtitle('Reanalysis CCA')

prism_dat %>%
  spread(year, SWE) %>%
  mutate(column = 1:n()) %>%
  select(x, y, column) %>%
  bind_cols(prism_can) %>%
  gather(pattern, value, PC1:PC9) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = value)) +
  #geom_sf(data = states_wus, fill = NA, color = 'black') +
  facet_wrap(~pattern) +
  scale_fill_distiller(palette = 'RdBu') +
  theme_void()+
  coord_quickmap() +
  ggtitle('Observed CCA')
```

## EOTs


```{r}
can_cor$cor %>% c() %>% diag()

can_cor$ycoef

library(CCP)
CCP::p.asym(can_cor$cor,N = 29, p = 9, q = 9)


```

```{r}
library(remote)
eot1 <- cera_dat %>%
  filter(year >=1982) %>%
  spread(year, SWE) %>%
  rasterFromXYZ() %>%
  anomalize() %>%
  denoise(expl.var = .85)

eot2 <- prism_dat %>%
  select(-area) %>%
  filter(year <= 2010) %>%
  spread(year, SWE) %>%
  rasterFromXYZ() %>%
  anomalize() %>% 
  denoise(expl.var = .85)

telecon <- eot(eot1, eot2, n = 6)
```

```{r}
walk(1:6, ~plot(telecon, y = .))
```

```{r}
library(patchwork)
plot_cancor <- function(x1, x2, y1, y2){
  p1 <- x1 %>%
  spread(year, SWE) %>%
  mutate(column = 1:n()) %>%
  select(x, y, column) %>%
  bind_cols(x2) %>%
  gather(pattern, value, PC1:PC6) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = value)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  facet_wrap(~pattern) +
  scale_fill_distiller(palette = 'RdBu') +
  theme_void()+
  #coord_quickmap() +
  ggtitle('Reanalysis CCA') +
    theme(legend.position = 'bottom')

p2 <- y1 %>%
  spread(year, SWE) %>%
  mutate(column = 1:n()) %>%
  select(x, y, column) %>%
  bind_cols(y2) %>%
  gather(pattern, value, PC1:PC6) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = value)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  facet_wrap(~pattern) +
  scale_fill_distiller(palette = 'RdBu') +
  theme_void()+
  #coord_quickmap() +
  ggtitle('Observed CCA') +
  theme(legend.position = 'bottom')

p1 + p2
}

plot_cancor(cera_dat, cera_can, prism_dat, prism_can)
```

## Validation

```{r}
library(telefit)

t1 <- prism_dat %>%
  filter(year <= 2010) %>%
  select(-area) %>%
  snow_only() %>%
  spread(year, SWE) %>%
  select(-x, -y) %>%
  as.matrix()

t2 <- cera_dat %>%
  filter(year >= 1982) %>% 
  snow_only() %>%
  spread(year, SWE) %>%
  select(-x, -y) %>%
  as.matrix()


t3 <- prism_dat %>%
  filter(year <= 2010) %>%
  select(-area) %>%
  snow_only() %>%
  spread(year, SWE) %>%
  select(x, y)

preds <- cca.predict(t2, t1, t2, k.x = 9, k.y = 9)
1 - var(as.numeric(preds-t1)) / var(as.numeric(t1))

cca.predict
```

```{r}
preds %>%
as_tibble() %>%
  bind_cols(t3, .) %>%
  gather(year, SWE, `1982`:`2010`) %>%
  mutate(year = as.numeric(year)) %>%
  filter(year < 1985) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = SWE)) +
  scale_fill_viridis_c() +
  facet_wrap(~year) +
  coord_quickmap()
```
```{r}
prism_dat %>%
  group_by(x, y) %>%
  mutate(anomaly = SWE - mean(SWE)) %>%
  ungroup %>%
  filter(year < 1985) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = anomaly)) +
  scale_fill_viridis_c() +
  facet_wrap(~year) +
  coord_quickmap()
```


```{r}
test2 <- preds %>%
as_tibble() %>%
  bind_cols(t3, .) %>%
  rasterFromXYZ() 

plot((test2 * calc(prism, sd) + mean(prism)) - prism )

```

## CESM-LME Comparison

```{r}
cesm_h2osno <- preprocess('~/Downloads/b.e11.BLMTRC5CN.f19_g16.001.clm2.h1.H2OSNO.08500101-18491231.nc',
                          var = 'H2OSNO',
                          flip = TRUE)

cesm_h2osno_ext <- preprocess('~/Downloads/b.e11.BLMTRC5CN.f19_g16.001.clm2.h1.H2OSNO.18500101-20051231.nc',
                          var = 'H2OSNO',
                          flip = TRUE)
```


This comparison suggests that CESM is underpredicting SWE because of the simplified topography. Check this by looking at the underlying topography boundary files for that simulation.
```{r}
surface_geop <- raster('data/consistent-topo-fv1.9x2.5_c130424.nc', 
                       var = 'PHIS') %>%
  rotate() %>%
  crop(bbox, snap = 'out') %>%
  `/`(9.80665) %>%
  as.data.frame(na.rm = TRUE, xy = TRUE) 

landfrac <- raster('data/consistent-topo-fv1.9x2.5_c130424.nc', 
                   var = 'LANDFRAC') %>%
  rotate() %>%
  crop(bbox, snap = 'out')
```

```{r, echo = FALSE}
ggplot(surface_geop) +
  geom_raster(aes(x, y, fill = surface.geopotential)) +
  scale_fill_viridis_c() +
  geom_sf(data = states_wus, fill = NA, color = 'white') +
  theme_void() +
  ggtitle('CESM LME Topography')
```


```{r}
cesm_areas <- area(cesm_h2osno) %>%
  `*`(landfrac) %>%
  as.data.frame(xy = TRUE, na.rm = TRUE) %>%
  rename(area = layer)
```


still need to account for snow fraction of grid cell? and land fraction too?

```{r}
cesm_dat <- c(cesm_h2osno, cesm_h2osno_ext) %>%
  brick() %>%
  as.data.frame(xy = TRUE, na.rm = TRUE, long = TRUE) %>%
  mutate(year = str_sub(layer, 2) %>% parse_number() %>% round) %>%
  rename(SWE = value) %>%
  select(-layer) %>%
  left_join(cesm_areas, by = c('x', 'y'))
```

```{r animation_cesm, echo = FALSE, cache = TRUE}
cesm_dat %>%
  filter(year < 1000) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = SWE)) +
  geom_sf(data = states_wus, fill = NA, colour = 'white') +
  scale_fill_viridis_c() +
  coord_sf()+
  theme_void() +
  ggtitle("Simulated Snow Water Equivalent", "April 1st, {closest_state}") +
  transition_states(year)
```


```{r}
cesm_agg <- cesm_dat %>%
  group_by(year) %>%
  summarise(SWE = sum(SWE * area, na.rm = TRUE)) %>%
  mutate(avg = zoo::rollmean(SWE, k = 100, na.pad = TRUE))
```

```{r, echo = FALSE, warning = FALSE}
cesm_agg %>%
  filter(year <=1850) %>%
ggplot(aes(year, SWE)) +
  geom_line(alpha = .3) +
  #geom_point(aes(color = SWE)) +
    geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs", k = 30)) +
  geom_line(aes(y = avg), size = 1.2) +
  scale_color_viridis_c(guide = FALSE) +
  theme_minimal() +
  ggtitle('Simulated SWE over the Last Millennium')
```

```{r, echo = FALSE, fig.width = 3.5, fig.height = 8}
cesm_agg %>%
  mutate(period = floor((year / 30)) * 30) %>%
  ggplot(aes(SWE, period, group = period)) +
  geom_density_ridges(fill = 'lightgrey') +
  #ggridges::geom_density_ridges_gradient(stat = 'density', scale = 1.5)+
  #scale_fill_viridis_c(guide = F) +
  geom_vline(xintercept= c(mod_avg), linetype = 2) +
  ggridges::theme_ridges(grid = FALSE, center_axis_labels = TRUE)
```

## Reconstruction

```{r}
comb_pca <- ccsm_dat %>%
  select(-area) %>%
  filter(between(year, 1750, 1850)) %>%
  bind_rows(cera_dat) %>%
  snow_only() %>%
      spread(year, SWE) %>%
  remove_missing()%>%
  gather(year, SWE, `1750`:`2010`) %>%
  calc_pcs()

comb_eigs <- get_eigs(comb_pca, ccsm)
```

```{r, echo = FALSE}
plotnScree(nScree(comb_eigs$eigenvalues))
```

```{r}
comb_eofs <- get_eofs(comb_pca, comb_eigs, 9)
```

```{r plot_variance_obs, echo = FALSE}
plot_scree(comb_eigs, 9)
```

```{r, echo = FALSE}
plot_eof(prism_dat, prism_eofs)

plot_eof(cera_dat, cera_eofs)

ccsm_dat %>%
  select(-area) %>%
    filter(between(year, 1800, 1836)) %>%
  bind_rows(cera_dat) %>%
  remove_missing() %>%
   plot_eof(remove_missing(comb_eofs))

plot_eof(ccsm_dat, sim_eofs)
```


## Reanalysis

So the question now is whether the mismatch between observed and simulated SWE is due to the meteorolgical forcing. That is, if only we had better temperature and precipitation simulations then we could model SWE as a simple function of those. To examine this, use reanalysis data.

Start by importing ERA5 data.
```{r}
ncdf_file <- 'data/adaptor.mars.internal-1566933160.7965047-18657-23-b3ae7b43-15db-4890-bc5b-4d3413fe4ddd.nc'
ref <- brick(ncdf_file, var = 'sd') %>% 
  .[[1]]%>%
  rotate %>%
  crop(bbox)

elev2 <- resample(elev[[1]], ref)
```

We need to use snowdepth rather than SWE, but as shown above this isn't a huge deal in the long run. Here just import April snowdepths, which we'll use as a rough equivalent for April 1st SWE.
```{r}
snowdepth <- brick(ncdf_file, var = 'sd') %>% 
  .[[seq(4,484, 12)]] %>% # get april
  rotate %>%
  crop(bbox) %>%
  mask(elev2) %>%
  as.data.frame(xy = TRUE, long = TRUE, na.rm = TRUE) %>%
  rename(time = layer, sd = value)
```

Also import temperature and precipitation for all months.
```{r}
temp <- brick(ncdf_file, var = 't2m') %>% 
  rotate %>%
  crop(bbox) %>%
  mask(elev2) %>%
  as.data.frame(xy = TRUE, long = TRUE, na.rm = TRUE) %>%
  rename(time = Z, t2m = value)

precip <- brick(ncdf_file, var = 'tp') %>% 
  rotate %>%
  crop(bbox) %>%
  mask(elev2) %>%
  as.data.frame(xy = TRUE, long = TRUE, na.rm = TRUE) %>%
  rename(time = Z, tp = value)
```

Calculate the mean temperature and total precipitation for Oct-Mar to see if there's any relationship to snowdepth.
```{r}
dat <- precip %>%
  left_join(temp, by = c('x', 'y', 'time')) %>%
  mutate(t2m = t2m - 273.15) %>%
  separate(time, into = c('year', 'month', 'day'), convert = TRUE) %>%
  mutate(water_year = if_else(month < 10, year, year + 1L)) %>%
  filter(between(water_year, 1980, 2018)) %>%
  filter(month %in% c(1:3, 9:12)) %>%
  group_by(x, y, water_year) %>%
  summarise(t2m = mean(t2m), tp = sum(tp))
```

Combine all the data.
```{r}
dat2 <- snowdepth %>%
  mutate(time = str_sub(time, start = 2)) %>%
  separate(time, into = c('year', 'month', 'day'), convert = TRUE) %>%
  select(-day, -month) %>%
  left_join(dat, by = c('x', 'y', 'year' = 'water_year')) %>%
  remove_missing()
```

The spatial and temporal variability of the reanalysis snow depth looks close to observations, so that's a good sign.

```{r, echo = FALSE, cache = TRUE}
dat2 %>%
  ggplot() +
  geom_raster(aes(x, y, fill = sd)) +
  scale_fill_viridis_c() +
  geom_sf(data = states_wus, fill = NA, color = 'white') +
  theme_void() +
  ggtitle("Year: {closest_state}") +
  transition_states(year)
```

Fit a GAM predicting snow depth as a nonlinear interaction between seasonal temperature and precipitation. Include terms to account for spatial and temporal autocorrelation

```{r}
mod <- dat2 %>%
  mutate(start = if_else(year == min(year), TRUE, FALSE)) %>%
  arrange(x, y) %>%
  bam(sd ~ te(t2m, tp) + te(x,y), data = ., AR.start = start)
```

The model performs suprisingly well.
```{r}
summary(mod)
plot(mod, scheme = 1)
```

Plotting the results, it does indeed look like we can predict SWE/snow depth, or at least climatological SWE, from temperature and precipitation data.
```{r, echo = FALSE}
dat2 %>%
  mutate(pred = predict(mod, .)) %>%
  group_by(x, y) %>%
  summarise(Simulated = mean(sd), Predicted = mean(pred)) %>%
  gather(type, value, 3:4) %>%
  ggplot() +
  scale_fill_viridis_c() +
  geom_raster(aes(x, y, fill = value)) +
  facet_wrap(~type) +
  geom_sf(data = states_wus, fill = NA, color = 'white') +
  theme_void() +
  ggtitle('Simulated vs predicted snow depth based on meteorological data', 'ERA5 Reanalysis')
```


## Other Analyses

### Trend Analysis

Fit a geographically weighted regression to look at spatially varying SWE trends in the observations.
```{r cache = TRUE}
m1 <- bam(SWE ~ te(x, y, by = year, k = 20), data = snow_dat)
```

The model's fine ... not good, not great.
```{r}
summary(m1)
```
Looks good down here, but these are in absolute numbers. Maybe rescale to look at relative change?

```{r, echo = FALSE}
snow_dat %>%
  filter(year == 1999) %>%
  mutate(pred = predict(m1, ., type = 'response')) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = pred)) +
  scale_fill_distiller(palette = 'RdBu', direction = 1, limits = c(-1000, 1000)) +
    geom_sf(data = states_wus, fill = NA, color = 'black') +
theme_void() +
  ggtitle('Estimated SWE trends in observations', '. . . maybe . . .')
```


### Snow Density

Let's model the relationship between snow depth and snow water equivalent (i.e. snow density) in the observations. Looks like its roughly linear.

```{r}
snow_dat %>%
  ggplot(aes(DEPTH, SWE)) +
  geom_point() +
  theme_minimal()
```

```{r, cache = TRUE}
m2 <- bam(SWE ~ s(DEPTH), data = snow_dat, discrete = TRUE)
```

The GAM explains 98% of the deviance, so not bad at all.
```{r}
plot(m2)
summary(m2)
```

The residuals from the (roughly) linaer fit between SWE and depth show some interesting structure. Might be worthwhile to explore later.

```{r, echo = FALSE}
test <- snow_dat %>%
  mutate(error = SWE - predict(m2, .))

test %>%
  filter(year %in% 1995:2000) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = error)) +
  scale_fill_distiller(palette = 'RdBu', direction = 1, limits =c(-660, 580)) +
  facet_wrap(~year) +
  
  coord_quickmap()+
  theme_void()
```



### Temporal Autocorrelation

What about the temporal autocorrelation in the observations and simulations?
```{r, echo = FALSE, warning = FALSE}
prism_dat %>%
  group_by(x, y) %>%
  mutate(rho = cor(SWE, lag(SWE), use = 'complete.obs')) %>%
   ggplot(aes(x, y)) +
  geom_raster(aes(fill = rho)) +
  scale_fill_distiller(palette = 'RdBu', direction = 1, limits =c(-1, 1)) +
  coord_quickmap()+
  theme_void() 
```

```{r, echo = FALSE, warning = FALSE}
cesm_dat %>%
  group_by(x, y) %>%
  mutate(rho = cor(SWE, lag(SWE), use = 'complete.obs')) %>%
   ggplot(aes(x, y)) +
  geom_raster(aes(fill = rho)) +
  scale_fill_distiller(palette = 'RdBu', direction = 1, limits =c(-1, 1)) +
  coord_quickmap()+
  theme_void() 
```

```{r, echo = FALSE}
knitr::knit_exit()
```


Compare to climatological data for annual temperature range.

```{r}
temp_range <- brick('data/CHELSA_bio10_07.tif') %>%
  crop(bbox)%>%
  `/`(10)

prec_djf <- (raster('data/CHELSA_prec_01_V1.2_land.tif') + 
  raster('data/CHELSA_prec_02_V1.2_land.tif') + 
  raster('data/CHELSA_prec_12_V1.2_land.tif')) %>%
  crop(bbox) %>%
  `/`(3)
```

```{r}
plot(prec_djf)
```

```{r}
plot(temp_range/10)
```
